<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>High Temperature Prediction Market Guidance</title>
  <style>
    :root{
      --bg:#0a0c10;
      --panel:#0f131a;
      --panel2:#0c1016;
      --line:#1b2330;
      --text:#e9eef7;
      --muted:#a0aec2;
      --blue:#7fb4ff;      /* light blue accent */
      --blue2:#a6ccff;
      --good:#2cc38a;
      --warn:#f3c969;
      --bad:#ff6b6b;
      --shadow: 0 16px 55px rgba(0,0,0,.45);
      --radius:10px;       /* less rounded */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:26px 18px 44px}
    header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;
      padding-bottom:18px;border-bottom:1px solid rgba(255,255,255,.08);
    }
    .brand{display:flex;flex-direction:column;gap:8px}
    .brand h1{
      margin:0;
      font-size:48px;
      font-weight:900;
      letter-spacing:.18em;
      line-height:1;
      color:var(--text);
    }
    .sub{
      color:var(--muted);
      font-weight:800;
      letter-spacing:.08em;
      font-size:13px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr 1fr;
      gap:18px;
      margin-top:22px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      letter-spacing:.14em;
      font-weight:900;
      color:#c2cde0;
      text-transform:uppercase;
      font-size:12px;
    }
    .card-b{padding:16px}
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    label{
      display:block;
      color:#c2cde0;
      font-weight:900;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:12px;
      margin-bottom:10px;
    }
    select, input{
      width:100%;
      padding:16px 14px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,14,20,.85);
      color: var(--text);
      outline:none;
      font-size:18px;
    }
    select:focus, input:focus{border-color: rgba(127,180,255,.55)}
    .btn{
      width:100%;
      margin-top:14px;
      padding:16px 16px;
      border-radius: 10px;
      border:1px solid rgba(127,180,255,.65);
      background: rgba(127,180,255,.18);
      color: var(--text);
      font-weight:900;
      font-size:18px;
      letter-spacing:.04em;
      cursor:pointer;
    }
    .btn:hover{filter:brightness(1.05)}

    .btnSecondary{
      width:100%;
      margin-top:12px;
      padding:14px 16px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-weight:900;
      font-size:16px;
      letter-spacing:.04em;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btnSecondary:hover{border-color: rgba(127,180,255,.35)}

    .status{
      display:flex;align-items:center;gap:10px;margin-top:14px;
      color: var(--muted);
      font-weight:800;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#667;box-shadow:0 0 0 3px rgba(255,255,255,.05)}
    .dot.ok{background: var(--good)}
    .dot.err{background: var(--bad)}
    .dot.busy{background: var(--blue)}
    .big{
      font-size:56px;
      font-weight:900;
      letter-spacing:.02em;
      margin:6px 0 0;
    }
    .subtitle{
      color:var(--muted);
      font-weight:800;
      letter-spacing:.01em;
      margin-top:6px;
      font-size:16px;
    }
    .miniGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    .mini{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,20,.55);
      border-radius: 12px;
      padding:12px;
    }
    .mini h4{
      margin:0 0 8px;
      letter-spacing:.14em;
      font-weight:900;
      text-transform:uppercase;
      color:#c2cde0;
      font-size:12px;
    }
    .mini .val{
      font-size:14px;
      font-weight:900;
      color: var(--text);
      line-height:1.35;
      word-break: break-word;
    }

    .chartWrap{
      margin-top:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,20,.55);
      border-radius: 12px;
      padding:12px;
      position:relative;
    }
    .legend{
      position:absolute;
      top:10px;
      right:12px;
      display:flex;
      gap:12px;
      align-items:center;
      font-weight:900;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#c2cde0;
      background: rgba(10,14,20,.65);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;
      border-radius: 10px;
    }
    .sw{
      width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px;
    }
    .sw.fair{background: var(--blue)}
    .sw.you{background: var(--warn)}
    canvas{width:100%;height:280px;display:block}

    .pillRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    .pill{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      justify-content:space-between;
    }
    .pill .k{
      color:var(--muted);
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size:11px;
    }
    .pill .v{
      font-weight:900;
      font-size:14px;
      letter-spacing:.02em;
      color:var(--text);
      text-align:right;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand h1{font-size:36px}
      .pillRow{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>MetApplication</h1>
        <div class="sub">HIGH TEMPERATURE PREDICTION MARKET GUIDANCE</div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="card-h">
          <div>Inputs</div>
          <div id="cityTag" style="font-weight:900;letter-spacing:.14em;color:#c2cde0;text-transform:uppercase;">—</div>
        </div>
        <div class="card-b">
          <div class="row">
            <div>
              <label for="city">City</label>
              <select id="city">
                <option value="den">Denver</option>
                <option value="nyc">New York City</option>
                <option value="dal">Dallas</option>
                <option value="chi">Chicago</option>
              </select>
            </div>
            <div>
              <label for="date">Date</label>
              <select id="date"></select>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div>
              <label for="t">Potential High Temp</label>
              <select id="t"></select>
            </div>
            <div>
              <label for="yes">Yes Cost</label>
              <input id="yes" inputmode="decimal" placeholder="e.g. 32" />
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div>
              <label for="no">No Cost</label>
              <input id="no" inputmode="decimal" placeholder="e.g. 68" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn" id="go">Evaluate Market</button>
            </div>
          </div>

          <!-- ONLY ONE BUTTON that goes to drought.html -->
          <a class="btnSecondary" href="/drought.html">Open Drought Odds</a>

          <div class="status" id="status">
            <span class="dot ok" id="dot"></span>
            <span id="statusText">Ready</span>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-h">
          <div>Result</div>
          <div id="cityTop" style="font-weight:900;letter-spacing:.14em;color:#c2cde0;text-transform:uppercase;">—</div>
        </div>
        <div class="card-b">

          <!-- current time/temp NOT in header -->
          <div class="pillRow">
            <div class="pill">
              <div class="k">Local Time</div>
              <div class="v" id="localTime">—</div>
            </div>
            <div class="pill">
              <div class="k">Current Temp</div>
              <div class="v" id="currentTemp">—</div>
            </div>
          </div>

          <div class="big" id="signal">—</div>
          <div class="subtitle" id="subline">—</div>

          <div class="miniGrid">
            <div class="mini">
              <h4>Fair Yes</h4>
              <div class="val" id="fairYes">—</div>
            </div>
            <div class="mini">
              <h4>Fair No</h4>
              <div class="val" id="fairNo">—</div>
            </div>
            <div class="mini">
              <h4>Your Yes</h4>
              <div class="val" id="yourYes">—</div>
            </div>
            <div class="mini">
              <h4>Your No</h4>
              <div class="val" id="yourNo">—</div>
            </div>
          </div>

          <div class="chartWrap">
            <div class="legend">
              <span><span class="sw fair"></span>Fair Price</span>
              <span><span class="sw you"></span>Your Price</span>
            </div>
            <canvas id="chart" width="900" height="280"></canvas>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  const cityNames = { den:"Denver", nyc:"New York City", dal:"Dallas", chi:"Chicago" };

  let latestHighs = []; // [{date:"YYYY-MM-DD", high_f:..}]
  let timer = null;

  function setStatus(kind, text){
    const dot = $("dot");
    dot.className = "dot " + (kind || "ok");
    $("statusText").textContent = text;
  }

  function pct(x){
    if (x === null || x === undefined || Number.isNaN(x)) return "—";
    return (x*100).toFixed(1) + "%";
  }

  function money(x){
    if (x === null || x === undefined || Number.isNaN(x)) return "—";
    return (x*100).toFixed(1) + "¢";
  }

  function populateTemps(){
    const sel = $("t");
    sel.innerHTML = "";
    for(let f=40; f<=110; f+=1){
      const o = document.createElement("option");
      o.value = String(f);
      o.textContent = String(f) + "°F";
      sel.appendChild(o);
    }
    sel.value = "73";
  }

  function populateDates(){
    const sel = $("date");
    sel.innerHTML = "";
    for(const h of latestHighs){
      const o = document.createElement("option");
      o.value = h.date;
      o.textContent = h.date;
      sel.appendChild(o);
    }
  }

  async function loadHighs(){
    const city = $("city").value;
    $("cityTag").textContent = (cityNames[city] || "—").toUpperCase();
    $("cityTop").textContent = (cityNames[city] || "—").toUpperCase();

    setStatus("busy", "Loading…");
    try{
      const res = await fetch(`/api/highs?city=${encodeURIComponent(city)}`);
      const data = await res.json();
      if(data.error){
        setStatus("err", data.error);
        return;
      }
      latestHighs = data.highs || [];
      populateDates();
      setStatus("ok", "Ready");
    }catch(e){
      setStatus("err", "Network error");
    }
  }

  // ---- Current Temp + Local Time (server-side /api/now) ----
  function fmtLocal(iso){
    try{
      const d = new Date(iso);
      // nice short format
      return new Intl.DateTimeFormat(undefined, {
        weekday:"short",
        month:"short",
        day:"numeric",
        hour:"numeric",
        minute:"2-digit"
      }).format(d);
    }catch(e){
      return "—";
    }
  }

  async function refreshNowPanel(){
    const city = $("city").value;
    try{
      const res = await fetch(`/api/now?city=${encodeURIComponent(city)}`);
      const data = await res.json();
      if(data.error){
        $("localTime").textContent = "—";
        $("currentTemp").textContent = "—";
        return;
      }

      // prefer obs time if available; else server local time
      const lt = data.obs_local_time || data.server_local_time;
      $("localTime").textContent = lt ? fmtLocal(lt) : "—";

      const tf = data.temp_f;
      if(typeof tf === "number" && !Number.isNaN(tf)){
        $("currentTemp").textContent = `${tf.toFixed(1)}°F`;
      }else{
        $("currentTemp").textContent = "—";
      }
    }catch(e){
      $("localTime").textContent = "—";
      $("currentTemp").textContent = "—";
    }
  }

  function startNowTicker(){
    if(timer) clearInterval(timer);
    refreshNowPanel();
    timer = setInterval(refreshNowPanel, 60000);
  }

  // ---- Chart: backend curve (/api/curve) ----
  function drawChartFromPoints(points, tVal, fairAtT, yourAtT){
    const c = $("chart");
    const ctx = c.getContext("2d");
    const w = c.width, h = c.height;

    ctx.clearRect(0,0,w,h);

    const padL = 54, padR = 22, padT = 18, padB = 36;
    const plotW = w - padL - padR;
    const plotH = h - padT - padB;

    // grid + y labels
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1;
    ctx.fillStyle = "rgba(255,255,255,.35)";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    for(let i=0;i<=4;i++){
      const y = padT + (plotH * (i/4));
      ctx.beginPath();
      ctx.moveTo(padL, y);
      ctx.lineTo(padL+plotW, y);
      ctx.stroke();
      const p = (1 - i/4);
      ctx.fillText(Math.round(p*100)+"%", 10, y+4);
    }

    // x domain from returned points
    const t0 = points.length ? points[0].t : (tVal - 10);
    const t1 = points.length ? points[points.length-1].t : (tVal + 10);

    // x labels
    ctx.fillStyle = "rgba(255,255,255,.35)";
    for(let i=0;i<=4;i++){
      const x = padL + (plotW * (i/4));
      const tv = Math.round(t0 + (t1-t0)*(i/4));
      ctx.fillText(tv+"°", x-10, padT+plotH+24);
    }

    // axis lines
    ctx.strokeStyle = "rgba(255,255,255,.18)";
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT+plotH);
    ctx.lineTo(padL+plotW, padT+plotH);
    ctx.stroke();

    // fair curve
    ctx.lineWidth = 3;
    ctx.strokeStyle = "rgba(127,180,255,.95)";
    ctx.beginPath();
    for(let i=0;i<points.length;i++){
      const tv = points[i].t;
      const p = Math.max(0, Math.min(1, points[i].p_yes));
      const x = padL + (plotW * ((tv - t0)/(t1-t0)));
      const y = padT + (plotH * (1 - p));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // x position for chosen threshold
    const xP = padL + (plotW * ((tVal - t0)/(t1-t0)));

    // your point (YES price)
    const yY = padT + (plotH * (1 - Math.max(0, Math.min(1, yourAtT))));
    ctx.fillStyle = "rgba(243,201,105,.95)";
    ctx.beginPath();
    ctx.arc(xP, yY, 6, 0, Math.PI*2);
    ctx.fill();

    // fair point at tVal
    const yF = padT + (plotH * (1 - Math.max(0, Math.min(1, fairAtT))));
    ctx.fillStyle = "rgba(127,180,255,.95)";
    ctx.beginPath();
    ctx.arc(xP, yF, 5, 0, Math.PI*2);
    ctx.fill();
  }

  async function drawChartBackend(city, date, tVal, fairYes, yourYes){
    // show a window around threshold
    const minF = Math.max(30, tVal - 10);
    const maxF = Math.min(120, tVal + 10);
    const url = `/api/curve?city=${encodeURIComponent(city)}&date_str=${encodeURIComponent(date)}&min_f=${encodeURIComponent(minF)}&max_f=${encodeURIComponent(maxF)}&steps=61`;

    try{
      const res = await fetch(url);
      const data = await res.json();
      if(data.error || !Array.isArray(data.points)){
        // fallback simple flat chart
        drawChartFromPoints([{t:minF,p_yes:0.5},{t:maxF,p_yes:0.5}], tVal, fairYes, yourYes);
        return;
      }
      drawChartFromPoints(data.points, tVal, fairYes, yourYes);
    }catch(e){
      drawChartFromPoints([{t:minF,p_yes:0.5},{t:maxF,p_yes:0.5}], tVal, fairYes, yourYes);
    }
  }

  async function evaluate(){
    const city = $("city").value;
    const date = $("date").value;
    const t = parseFloat($("t").value);
    const yes = parseFloat($("yes").value);
    const no = parseFloat($("no").value);

    if(!date || Number.isNaN(t) || Number.isNaN(yes) || Number.isNaN(no)){
      setStatus("err", "Missing inputs");
      return;
    }

    setStatus("busy", "Evaluating…");

    try{
      const res = await fetch("/api/evaluate_one", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          city,
          date,
          threshold_f: t,
          yes_cents: yes,
          no_cents: no
        })
      });

      const data = await res.json();
      if(data.error){
        setStatus("err", data.error);
        $("signal").textContent = "—";
        $("subline").textContent = "—";
        $("fairYes").textContent = "—";
        $("fairNo").textContent = "—";
        $("yourYes").textContent = "—";
        $("yourNo").textContent = "—";
        await drawChartBackend(city, date, t, 0.5, 0.5);
        return;
      }

      const fairYes = data.fair_yes;
      const fairNo = data.fair_no;
      const yourYes = data.market_yes;
      const yourNo = data.market_no;

      $("signal").textContent = data.signal;

      // show nowcast in subline (mu is nowcast-adjusted in server.py)
      const mu = (typeof data.mu === "number") ? data.mu : null;
      const sig = (typeof data.sigma === "number") ? data.sigma : null;
      $("subline").textContent = `Fair YES ${pct(fairYes)} · μ ${mu !== null ? mu.toFixed(1) : "—"}°F · σ ${sig !== null ? sig.toFixed(1) : "—"}°F`;

      $("fairYes").textContent = pct(fairYes);
      $("fairNo").textContent = pct(fairNo);
      $("yourYes").textContent = money(yourYes);
      $("yourNo").textContent = money(yourNo);

      await drawChartBackend(city, date, t, fairYes, yourYes);

      setStatus("ok", "OK");
    }catch(e){
      setStatus("err", "Network error");
    }
  }

  $("city").addEventListener("change", async ()=>{
    await loadHighs();
    startNowTicker();
  });

  $("go").addEventListener("click", evaluate);

  (function init(){
    populateTemps();
    loadHighs().then(()=>startNowTicker());
    // initial chart placeholder
    drawChartFromPoints([{t:63,p_yes:0.5},{t:83,p_yes:0.5}], 73, 0.5, 0.5);

    $("cityTag").textContent = (cityNames[$("city").value] || "—").toUpperCase();
    $("cityTop").textContent = (cityNames[$("city").value] || "—").toUpperCase();
  })();
</script>
</body>
</html>
