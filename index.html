<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MetApplication</title>
  <style>
    :root{
      --bg:#07090d;
      --panel:#0e121a;
      --panel2:#0b0f16;
      --border:#1d2634;
      --muted:#9aa7b8;
      --text:#e8eef7;
      --blue:#63a8ff;
      --blue2:#7fc1ff;
      --chip:#101827;
      --good:#3ddc97;
      --warn:#ffd166;
      --bad:#ff5c7a;

      --radius:10px;   /* less rounded */
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 30% -10%, rgba(99,168,255,.12), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(127,193,255,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Helvetica, Arial, sans-serif;
      letter-spacing:.1px;
    }

    /* top header */
    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      padding:22px 26px 14px;
      border-bottom:1px solid rgba(29,38,52,.9);
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .brand .title{
      font-size:34px;
      font-weight:800;
      letter-spacing:1.4px; /* requested spacing */
      line-height:1;
    }
    .brand .sub{
      font-size:12px;
      font-weight:700;
      letter-spacing:1.8px;
      text-transform:uppercase;
      color:rgba(154,167,184,.85);
    }

    .nav{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .nav a{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid rgba(29,38,52,.95);
      background: rgba(14,18,26,.75);
      color:var(--text);
      text-decoration:none;
      border-radius:9px;
      font-weight:700;
      font-size:13px;
    }
    .nav a:hover{border-color:rgba(99,168,255,.55)}
    .nav a.primary{
      border-color:rgba(99,168,255,.55);
      background: rgba(99,168,255,.10);
    }
    .dot{
      width:10px;height:10px;border-radius:2px;
      background: var(--blue);
      box-shadow: 0 0 0 3px rgba(99,168,255,.12);
    }

    /* layout */
    .wrap{
      max-width:1280px;
      margin:0 auto;
      padding:18px 26px 34px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.35fr .95fr;
      gap:16px;
      align-items:start;
      margin-top:18px;
    }

    .card{
      background: linear-gradient(180deg, rgba(14,18,26,.92), rgba(10,14,20,.92));
      border:1px solid rgba(29,38,52,.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      background: rgba(7,9,13,.35);
      border-bottom:1px solid rgba(29,38,52,.95);
      font-weight:800;
      letter-spacing:1.2px;
      text-transform:uppercase;
      font-size:12px;
      color: rgba(154,167,184,.9);
    }
    .card .body{padding:16px}

    /* form */
    label{
      display:block;
      font-size:12px;
      font-weight:800;
      letter-spacing:1.2px;
      text-transform:uppercase;
      color: rgba(154,167,184,.9);
      margin:0 0 8px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-bottom:14px;
    }
    .row3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
      margin-bottom:14px;
    }
    select, input{
      width:100%;
      padding:14px 14px;
      border-radius:9px;
      border:1px solid rgba(29,38,52,.95);
      background: rgba(8,12,18,.7);
      color: var(--text);
      outline:none;
      font-size:15px;
    }
    select:focus, input:focus{border-color:rgba(99,168,255,.6); box-shadow: 0 0 0 4px rgba(99,168,255,.12);}
    .btn{
      width:100%;
      padding:14px 16px;
      border-radius:10px;
      border:1px solid rgba(99,168,255,.70);
      background: rgba(99,168,255,.92);
      color:#06101e;
      font-weight:900;
      font-size:16px;
      letter-spacing:.4px;
      cursor:pointer;
    }
    .btn:hover{filter:brightness(1.02)}
    .btn:active{transform: translateY(1px)}

    /* result column */
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(29,38,52,.95);
      background: rgba(16,24,39,.65);
      font-weight:900;
      letter-spacing:.4px;
      font-size:13px;
    }
    .pill .led{
      width:10px;height:10px;border-radius:999px;
      background: rgba(154,167,184,.55);
      box-shadow: 0 0 0 3px rgba(154,167,184,.10);
    }
    .pill.good .led{background: var(--good); box-shadow:0 0 0 3px rgba(61,220,151,.12)}
    .pill.warn .led{background: var(--warn); box-shadow:0 0 0 3px rgba(255,209,102,.12)}
    .pill.bad  .led{background: var(--bad);  box-shadow:0 0 0 3px rgba(255,92,122,.12)}

    .mini{
      background: rgba(14,18,26,.55);
      border:1px solid rgba(29,38,52,.95);
      border-radius:10px;
      padding:12px 12px;
      margin-top:12px;
    }
    .mini .k{
      font-size:12px;
      font-weight:900;
      letter-spacing:1.2px;
      text-transform:uppercase;
      color: rgba(154,167,184,.9);
      margin-bottom:6px;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:14px;
      color: rgba(232,238,247,.95);
      letter-spacing:.2px;
    }

    /* chart */
    .chartBox{
      background: rgba(8,12,18,.45);
      border:1px solid rgba(29,38,52,.95);
      border-radius:10px;
      padding:10px;
    }
    .legend{
      display:flex;
      align-items:center;
      gap:14px;
      justify-content:flex-end;
      padding:4px 6px 10px;
      font-weight:800;
      letter-spacing:1.1px;
      text-transform:uppercase;
      font-size:12px;
      color: rgba(154,167,184,.95);
    }
    .lgItem{display:flex;align-items:center;gap:8px}
    .sw{width:14px;height:14px;border-radius:4px;background:var(--blue)}
    .sw2{width:14px;height:14px;border-radius:999px;background:rgba(200,225,255,.90); border:2px solid rgba(99,168,255,.30)}

    canvas{width:100%; height:220px; display:block}

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      canvas{height:200px}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="title">MetApplication</div>
      <div class="sub">HIGH TEMPERATURE PREDICTION MARKET GUIDANCE</div>
    </div>

    <nav class="nav">
      <a class="primary" href="index.html"><span class="dot"></span>Temperature</a>
      <a href="drought.html"><span class="dot" style="background: rgba(127,193,255,.9)"></span>Drought Odds</a>
    </nav>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Inputs -->
      <section class="card">
        <div class="hdr">
          <div>Inputs</div>
          <div style="font-weight:800;color:rgba(154,167,184,.75);letter-spacing:.7px;text-transform:none;">Enter the contract and click Evaluate Market.</div>
        </div>
        <div class="body">
          <div class="row">
            <div>
              <label for="city">City</label>
              <select id="city">
                <option>Denver</option>
                <option>New York City</option>
                <option>Dallas</option>
                <option>Chicago</option>
              </select>
            </div>
            <div>
              <label for="date">Date</label>
              <select id="date"></select>
            </div>
          </div>

          <div class="row3">
            <div>
              <label for="temp">Potential High Temp</label>
              <select id="temp"></select>
            </div>
            <div>
              <label for="yes">Yes Cost</label>
              <input id="yes" inputmode="numeric" placeholder="cents" value="30">
            </div>
            <div>
              <label for="no">No Cost</label>
              <input id="no" inputmode="numeric" placeholder="cents" value="70">
            </div>
          </div>

          <button class="btn" id="go">Evaluate Market</button>
        </div>
      </section>

      <!-- Result -->
      <aside class="card">
        <div class="hdr">
          <div>Result</div>
          <div id="headline" style="font-weight:900;color:rgba(232,238,247,.92);letter-spacing:.6px;">BUY YES / BUY NO / PASS</div>
        </div>
        <div class="body">
          <div class="chartBox">
            <div class="legend">
              <div class="lgItem"><span class="sw"></span>Fair Price</div>
              <div class="lgItem"><span class="sw2"></span>Your Price</div>
            </div>
            <canvas id="chart" width="900" height="360"></canvas>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px;align-items:center;justify-content:flex-start;">
            <div id="pill" class="pill"><span class="led"></span><span id="pillText">—</span></div>
          </div>

          <div class="mini">
            <div class="k">Contract</div>
            <div class="mono" id="line">—</div>
          </div>

          <div class="mini">
            <div class="k">Market</div>
            <div class="mono" id="mkt">—</div>
          </div>

          <div class="mini">
            <div class="k">Model</div>
            <div class="mono" id="mdl">—</div>
          </div>

          <div class="mini">
            <div class="k">Fair</div>
            <div class="mono" id="fair">—</div>
          </div>

          <div class="mini">
            <div class="k">Edge</div>
            <div class="mono" id="edge">—</div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // ---- UI helpers
    const $ = (id) => document.getElementById(id);

    // Populate next 14 days (client-side) as default.
    // Your backend can still accept any mm/dd/yyyy you send.
    function pad(n){ return String(n).padStart(2,'0'); }
    function mmddyyyy(d){
      return `${pad(d.getMonth()+1)}/${pad(d.getDate())}/${d.getFullYear()}`;
    }

    (function initDates(){
      const sel = $("date");
      const now = new Date();
      for(let i=0;i<14;i++){
        const d = new Date(now.getTime() + i*86400000);
        const opt = document.createElement("option");
        opt.value = mmddyyyy(d);
        opt.textContent = mmddyyyy(d);
        sel.appendChild(opt);
      }
    })();

    // Populate temps (30..110)
    (function initTemps(){
      const sel = $("temp");
      for(let t=30;t<=110;t++){
        const opt = document.createElement("option");
        opt.value = String(t);
        opt.textContent = String(t);
        if(t===42) opt.selected = true;
        sel.appendChild(opt);
      }
    })();

    function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

    // ---- chart rendering (fair curve + your point)
    function drawChart({mu, sigma, yourTemp, fairAtYourTemp, yourYesPrice}){
      const c = $("chart");
      const ctx = c.getContext("2d");

      // Fit x-range around mu so curve looks meaningful
      const xmin = Math.floor(mu - 4*sigma);
      const xmax = Math.ceil(mu + 4*sigma);

      // But also include yourTemp if it's outside
      const XMIN = Math.min(xmin, yourTemp - 3);
      const XMAX = Math.max(xmax, yourTemp + 3);

      const W = c.width, H = c.height;
      ctx.clearRect(0,0,W,H);

      // Background
      ctx.fillStyle = "rgba(8,12,18,.25)";
      ctx.fillRect(0,0,W,H);

      // Plot area
      const padL = 52, padR = 20, padT = 18, padB = 46;
      const PW = W - padL - padR;
      const PH = H - padT - padB;

      // Grid
      ctx.strokeStyle = "rgba(255,255,255,.06)";
      ctx.lineWidth = 1;

      const vlines = 6, hlines = 4;
      for(let i=0;i<=vlines;i++){
        const x = padL + (PW*i/vlines);
        ctx.beginPath(); ctx.moveTo(x,padT); ctx.lineTo(x,padT+PH); ctx.stroke();
      }
      for(let j=0;j<=hlines;j++){
        const y = padT + (PH*j/hlines);
        ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+PW,y); ctx.stroke();
      }

      // Axes labels
      ctx.fillStyle = "rgba(154,167,184,.85)";
      ctx.font = "700 14px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";

      function xToPx(x){ return padL + ( (x - XMIN) / (XMAX - XMIN) ) * PW; }
      function yToPx(p){ return padT + (1 - p) * PH; }

      // y labels (0.0, 0.5, 1.0)
      [0,0.5,1].forEach(p=>{
        const y = yToPx(p);
        ctx.fillText(p.toFixed(1), 12, y+5);
      });

      // x labels (min, your, max)
      const xTicks = [XMIN, Math.round((XMIN+XMAX)/2), XMAX];
      xTicks.forEach(x=>{
        const xp = xToPx(x);
        ctx.fillText(`${x}°F`, xp-16, padT+PH+32);
      });

      // Fair curve: use logistic-ish around mu (your backend is already doing normal CDF; this is just display)
      // We draw a smooth S-curve centered at mu.
      function fairProbAtTemp(temp){
        // Sigmoid with slope tuned by sigma
        const k = 1.15 / Math.max(1e-6, sigma);
        const z = (temp - mu) * k;
        return 1 / (1 + Math.exp(-z));
      }

      // Curve line
      ctx.strokeStyle = "rgba(99,168,255,.95)";
      ctx.lineWidth = 4;
      ctx.beginPath();
      let started = false;
      for(let x=XMIN; x<=XMAX; x+=0.25){
        const p = fairProbAtTemp(x);
        const xp = xToPx(x);
        const yp = yToPx(p);
        if(!started){ ctx.moveTo(xp,yp); started=true; }
        else ctx.lineTo(xp,yp);
      }
      ctx.stroke();

      // Your point (temp, yourYesPrice)
      const yp = yToPx(clamp(yourYesPrice, 0, 1));
      const xp = xToPx(yourTemp);

      // Outer glow
      ctx.beginPath();
      ctx.fillStyle = "rgba(99,168,255,.18)";
      ctx.arc(xp, yp, 18, 0, Math.PI*2);
      ctx.fill();

      // Point
      ctx.beginPath();
      ctx.fillStyle = "rgba(200,225,255,.95)";
      ctx.strokeStyle = "rgba(99,168,255,.35)";
      ctx.lineWidth = 4;
      ctx.arc(xp, yp, 9, 0, Math.PI*2);
      ctx.fill();
      ctx.stroke();

      // Thin line at fair point (optional small marker)
      const fairY = yToPx(clamp(fairAtYourTemp, 0, 1));
      ctx.beginPath();
      ctx.strokeStyle = "rgba(127,193,255,.65)";
      ctx.lineWidth = 2;
      ctx.moveTo(xp-10, fairY);
      ctx.lineTo(xp+10, fairY);
      ctx.stroke();
    }

    function setSignal(kind, text){
      const pill = $("pill");
      pill.classList.remove("good","warn","bad");
      if(kind) pill.classList.add(kind);
      $("pillText").textContent = text;
    }

    // ---- main evaluate
    $("go").addEventListener("click", async () => {
      const city = $("city").value;
      const date = $("date").value;          // mm/dd/yyyy
      const temp = parseInt($("temp").value, 10);
      const yesC = parseFloat($("yes").value);
      const noC  = parseFloat($("no").value);

      const yesPrice = clamp((yesC||0)/100, 0, 1);
      const noPrice  = clamp((noC||0)/100, 0, 1);

      // What we send to backend (your server.py already expects this in your current setup)
      const payload = { city, date, t: temp, yes_cents: yesC, no_cents: noC };

      $("line").textContent = `${date} — ${temp} — yes:${yesC} / no:${noC}`;
      $("headline").textContent = "…";
      setSignal(null, "…");

      try{
        const r = await fetch("/api/evaluate", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const data = await r.json();

        // Expecting backend to return:
        // { action, mu, sigma, p_yes, p_no, mkt_yes, mkt_no, edge_yes, edge_no }
        const action = (data.action || "PASS").toUpperCase();

        $("headline").textContent = action;

        const mu = Number(data.mu ?? temp);
        const sigma = Number(data.sigma ?? 3.0);

        $("mkt").textContent  = `YES ${Number(data.mkt_yes ?? yesPrice).toFixed(4)} | NO ${Number(data.mkt_no ?? noPrice).toFixed(4)}`;
        $("mdl").textContent  = `μ ${mu.toFixed(4)} | σ ${sigma.toFixed(4)}`;
        $("fair").textContent = `YES ${Number(data.p_yes ?? 0.5).toFixed(4)} | NO ${Number(data.p_no ?? 0.5).toFixed(4)}`;
        $("edge").textContent = `YES ${Number(data.edge_yes ?? 0).toFixed(4)} | NO ${Number(data.edge_no ?? 0).toFixed(4)}`;

        if(action.includes("BUY YES")) setSignal("good","BUY YES");
        else if(action.includes("BUY NO")) setSignal("good","BUY NO");
        else setSignal("warn","PASS");

        drawChart({
          mu, sigma,
          yourTemp: temp,
          fairAtYourTemp: Number(data.p_yes ?? 0.5),
          yourYesPrice: Number(data.mkt_yes ?? yesPrice)
        });
      }catch(e){
        $("headline").textContent = "ERROR";
        setSignal("bad","ERROR");
      }
    });

    // Initial chart placeholder
    drawChart({mu:42, sigma:2.5, yourTemp:42, fairAtYourTemp:0.5, yourYesPrice:0.3});
    setSignal("warn","PASS");
    $("headline").textContent = "BUY YES / BUY NO / PASS";
    $("mkt").textContent  = "—";
    $("mdl").textContent  = "—";
    $("fair").textContent = "—";
    $("edge").textContent = "—";
    $("line").textContent = "—";
  </script>
</body>
</html>
