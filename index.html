<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>High Temperature Prediction Market Guidance</title>
  <style>
    :root{
      --bg0:#0b1020;
      --bg1:#0f1630;
      --card:#0e1733cc;
      --card2:#111b3b;
      --line:#243159;
      --line2:#2e3a66;
      --text:#e8ecff;
      --muted:#aab3d8;
      --muted2:#7d88b5;
      --green:#2dd4bf;
      --green2:#1fb99f;
      --red:#fb7185;
      --red2:#f43f5e;
      --amber:#fbbf24;
      --blue:#60a5fa;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius:16px;
      --radius2:12px;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      --sans: -apple-system,BlinkMacSystemFont,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(96,165,250,.20), transparent 55%),
        radial-gradient(1000px 700px at 90% 20%, rgba(45,212,191,.14), transparent 55%),
        radial-gradient(900px 700px at 50% 100%, rgba(251,191,36,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,16,32,.82), rgba(11,16,32,.58));
      border-bottom:1px solid rgba(36,49,89,.55);
    }
    .topbar-inner{
      max-width:1180px;
      margin:0 auto;
      padding:16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:260px;
    }
    .logo{
      width:36px; height:36px; border-radius:12px;
      background:
        radial-gradient(12px 12px at 30% 35%, rgba(255,255,255,.75), transparent 65%),
        linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.85));
      box-shadow: 0 12px 30px rgba(45,212,191,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
      line-height:1.05;
    }
    .title h1{
      margin:0;
      font-size:14px;
      letter-spacing:.22px;
      font-weight:900;
      text-transform:none;
    }
    .title .sub{
      font-size:12px;
      color:var(--muted2);
      font-weight:700;
      letter-spacing:.2px;
    }

    .pillbar{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(46,58,102,.8);
      background: rgba(14,23,51,.55);
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      letter-spacing:.15px;
    }
    .pill strong{color:var(--text)}
    .wrap{
      max-width:1180px;
      margin:0 auto;
      padding:18px 18px 44px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:auto}
    }

    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(14,23,51,.72), rgba(14,23,51,.50));
      border: 1px solid rgba(36,49,89,.85);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(400px 160px at 20% 0%, rgba(96,165,250,.14), transparent 60%),
                  radial-gradient(420px 160px at 80% 0%, rgba(45,212,191,.10), transparent 60%);
      pointer-events:none;
    }
    .card-header{
      position:relative;
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(36,49,89,.75);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card-header h2{
      margin:0;
      font-size:12px;
      letter-spacing:.22px;
      font-weight:900;
      color: rgba(232,236,255,.95);
      text-transform:uppercase;
    }
    .card-body{
      position:relative;
      padding:14px;
    }

    .row{display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap}
    .field{display:flex; flex-direction:column; gap:7px}
    .label{
      font-size:11px;
      color: var(--muted2);
      font-weight:900;
      letter-spacing:.18px;
      text-transform:uppercase;
    }

    select, input, textarea, button{
      font: inherit;
      outline:none;
      border-radius: 12px;
      border:1px solid rgba(46,58,102,.95);
      background: rgba(17,27,59,.72);
      color: var(--text);
      padding: 11px 12px;
    }
    select{min-width:190px}
    input{width:140px}
    textarea{
      width:100%;
      min-height:150px;
      font-family: var(--mono);
      font-size:12px;
      line-height:1.35;
      background: rgba(11,16,32,.35);
    }
    input::placeholder{color: rgba(170,179,216,.55)}
    button{
      cursor:pointer;
      font-weight:900;
      letter-spacing:.14px;
      padding: 11px 12px;
      background: rgba(17,27,59,.72);
    }
    button:hover{border-color: rgba(96,165,250,.65)}
    button:disabled{opacity:.45; cursor:not-allowed}
    .btn-primary{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(45,212,191,.85));
      border-color: rgba(255,255,255,.10);
      color: #071025;
      box-shadow: 0 14px 40px rgba(45,212,191,.18);
    }
    .btn-danger{
      background: linear-gradient(135deg, rgba(251,113,133,.18), rgba(244,63,94,.10));
      border-color: rgba(244,63,94,.38);
      color: rgba(255,220,227,.95);
    }
    .btn-ghost{
      background: rgba(11,16,32,.35);
    }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 520px){
      .split{grid-template-columns:1fr}
      select, input{min-width: 100%; width:100%}
    }

    .status{
      margin-top:10px;
      font-size:12px;
      font-weight:800;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(170,179,216,.55);
      box-shadow: 0 0 0 6px rgba(170,179,216,.08);
    }
    .ok .dot{background: rgba(45,212,191,.92); box-shadow:0 0 0 6px rgba(45,212,191,.12)}
    .warn .dot{background: rgba(251,191,36,.95); box-shadow:0 0 0 6px rgba(251,191,36,.12)}
    .bad .dot{background: rgba(244,63,94,.92); box-shadow:0 0 0 6px rgba(244,63,94,.12)}
    .status .msg{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .errorbox{
      margin-top:10px;
      display:none;
      border-radius:12px;
      border:1px solid rgba(244,63,94,.35);
      background: rgba(244,63,94,.10);
      padding:10px 12px;
      color: rgba(255,220,227,.95);
      font-family: var(--mono);
      font-size:12px;
      white-space:pre-wrap;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:12px;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(36,49,89,.85);
      background: rgba(11,16,32,.25);
    }
    thead th{
      text-align:left;
      padding:10px 10px;
      font-size:11px;
      color: rgba(170,179,216,.85);
      font-weight:900;
      letter-spacing:.18px;
      text-transform:uppercase;
      background: rgba(17,27,59,.70);
      border-bottom: 1px solid rgba(36,49,89,.85);
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(36,49,89,.45);
      color: rgba(232,236,255,.90);
      vertical-align:top;
    }
    tbody tr:hover td{background: rgba(96,165,250,.06)}
    tbody tr:last-child td{border-bottom:none}

    .mono{font-family: var(--mono)}
    .muted{color: rgba(170,179,216,.85)}
    .kpi{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      color: rgba(170,179,216,.92);
      font-size:12px;
      font-weight:900;
    }
    .tag{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(46,58,102,.85);
      background: rgba(11,16,32,.35);
      color: rgba(170,179,216,.92);
      font-weight:900;
      letter-spacing:.12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .tag b{color: rgba(232,236,255,.95)}

    .signal{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      font-weight:1000;
      letter-spacing:.14px;
      border:1px solid rgba(46,58,102,.85);
      background: rgba(11,16,32,.35);
      white-space:nowrap;
    }
    .signal .s-dot{width:8px; height:8px; border-radius:999px; background: rgba(170,179,216,.6)}
    .signal.buyyes{border-color: rgba(45,212,191,.40); background: rgba(45,212,191,.10)}
    .signal.buyyes .s-dot{background: rgba(45,212,191,.95)}
    .signal.buyno{border-color: rgba(244,63,94,.40); background: rgba(244,63,94,.10)}
    .signal.buyno .s-dot{background: rgba(244,63,94,.95)}
    .signal.pass{border-color: rgba(170,179,216,.22); background: rgba(11,16,32,.25)}
    .signal.pass .s-dot{background: rgba(170,179,216,.65)}

    .footer-note{
      margin-top:14px;
      color: rgba(170,179,216,.62);
      font-size:11px;
      font-weight:800;
      letter-spacing:.12px;
      text-transform:uppercase;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>High Temperature Prediction Market Guidance</h1>
          <div class="sub">Paper • NOAA/NWS</div>
        </div>
      </div>

      <div class="pillbar">
        <div class="pill">City: <strong id="pillCity">den</strong></div>
        <div class="pill">Status: <strong id="pillStatus">idle</strong></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: INPUTS -->
      <div class="card">
        <div class="card-header">
          <h2>Trade</h2>
          <div class="kpi">
            <span class="tag">Queue <b id="qCount">0</b></span>
            <button id="btnEval" class="btn-primary">Run</button>
          </div>
        </div>

        <div class="card-body">
          <div class="row">
            <div class="field">
              <div class="label">City</div>
              <select id="city">
                <option value="den">den</option>
                <option value="nyc">nyc</option>
                <option value="dal">dal</option>
                <option value="chi">chi</option>
              </select>
            </div>

            <button id="btnHighs" class="btn-ghost">Load</button>

            <div style="flex:1"></div>

            <button id="btnClear" class="btn-danger" disabled>Clear</button>
          </div>

          <div class="split">
            <div class="field">
              <div class="label">Date</div>
              <select id="dateSel" disabled>
                <option value="">—</option>
              </select>
            </div>

            <div class="field">
              <div class="label">Temp</div>
              <select id="tempSel" disabled>
                <option value="">—</option>
              </select>
            </div>

            <div class="field">
              <div class="label">Yes</div>
              <input id="yesCents" inputmode="decimal" placeholder="cents" />
            </div>

            <div class="field">
              <div class="label">No</div>
              <input id="noCents" inputmode="decimal" placeholder="cents" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="btnAdd" class="btn-primary" disabled>Add</button>
          </div>

          <div class="field" style="margin-top:12px;">
            <div class="label">Queue</div>
            <textarea id="builtLines" class="mono" spellcheck="false" readonly></textarea>
          </div>

          <div id="status" class="status">
            <span class="dot"></span>
            <span class="msg" id="statusMsg">idle</span>
          </div>

          <div id="rawError" class="errorbox"></div>

          <div class="footer-note">mm/dd/yyyy - t - yes:$$ / no:$$</div>
        </div>
      </div>

      <!-- RIGHT: HIGHS -->
      <div class="card">
        <div class="card-header">
          <h2>Highs</h2>
          <div class="kpi">
            <span class="tag">Days <b id="hCount">0</b></span>
          </div>
        </div>

        <div class="card-body" style="padding:14px;">
          <div style="overflow:auto; max-height: 520px;">
            <table id="highsTable" style="display:none;">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>High</th>
                </tr>
              </thead>
              <tbody id="highsBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- RESULTS -->
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <h2>Results</h2>
        <div class="kpi">
          <span class="tag">Rows <b id="rCount">0</b></span>
        </div>
      </div>
      <div class="card-body">
        <div style="overflow:auto;">
          <table id="resultsTable" style="display:none;">
            <thead>
              <tr>
                <th>Contract</th>
                <th>Market</th>
                <th>Model</th>
                <th>Fair</th>
                <th>Edge</th>
                <th>Signal</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // On Render, this page is served by the same backend. Use relative URLs.
    const API_BASE = "";

    const elCity = document.getElementById("city");
    const btnHighs = document.getElementById("btnHighs");
    const btnEval = document.getElementById("btnEval");

    const elDateSel = document.getElementById("dateSel");
    const elTempSel = document.getElementById("tempSel");
    const elYes = document.getElementById("yesCents");
    const elNo = document.getElementById("noCents");
    const btnAdd = document.getElementById("btnAdd");
    const btnClear = document.getElementById("btnClear");
    const elBuilt = document.getElementById("builtLines");

    const elStatus = document.getElementById("status");
    const elStatusMsg = document.getElementById("statusMsg");
    const elRawError = document.getElementById("rawError");

    const elHighsTable = document.getElementById("highsTable");
    const elHighsBody = document.getElementById("highsBody");

    const elResultsTable = document.getElementById("resultsTable");
    const elResultsBody = document.getElementById("resultsBody");

    const pillCity = document.getElementById("pillCity");
    const pillStatus = document.getElementById("pillStatus");

    const qCount = document.getElementById("qCount");
    const hCount = document.getElementById("hCount");
    const rCount = document.getElementById("rCount");

    let highs = {};       // dateISO -> highF
    let builtLines = [];  // exact lines for backend

    function setPills() {
      pillCity.textContent = elCity.value;
    }

    function setStatus(msg, state="idle") {
      // state: idle | ok | warn | bad | run
      elStatusMsg.textContent = msg;
      pillStatus.textContent = state === "run" ? "running" : state;
      elStatus.className = "status " + (state === "ok" ? "ok" : state === "warn" ? "warn" : state === "bad" ? "bad" : "");
    }

    function showError(msg) {
      elRawError.style.display = "block";
      elRawError.textContent = msg;
      setStatus("error", "bad");
    }
    function clearError() {
      elRawError.style.display = "none";
      elRawError.textContent = "";
    }

    function isoToMDY(iso) {
      const [y,m,d] = iso.split("-");
      return `${m}/${d}/${y}`;
    }

    function parseNum(s) {
      const x = String(s || "").trim();
      if (!x) return null;
      const v = Number(x);
      if (!Number.isFinite(v)) return null;
      return v;
    }

    function updateAddEnabled() {
      const hasDate = !!elDateSel.value;
      const hasTemp = !!elTempSel.value;
      const yes = parseNum(elYes.value);
      const no = parseNum(elNo.value);
      btnAdd.disabled = !(hasDate && hasTemp && yes !== null && no !== null);
    }

    function rebuildQueue() {
      elBuilt.value = builtLines.join("\n");
      btnClear.disabled = builtLines.length === 0;
      qCount.textContent = String(builtLines.length);
    }

    function populateDateDropdown() {
      elDateSel.innerHTML = "";
      const keys = Object.keys(highs).sort();
      if (!keys.length) {
        elDateSel.innerHTML = `<option value="">—</option>`;
        elDateSel.disabled = true;
        return;
      }
      for (const iso of keys) {
        const opt = document.createElement("option");
        opt.value = iso;
        opt.textContent = iso;
        elDateSel.appendChild(opt);
      }
      elDateSel.disabled = false;
      elDateSel.value = keys[0];
    }

    function populateTempDropdownForDate() {
      elTempSel.innerHTML = "";
      const iso = elDateSel.value;
      if (!iso || highs[iso] === undefined) {
        elTempSel.innerHTML = `<option value="">—</option>`;
        elTempSel.disabled = true;
        return;
      }

      const mu = highs[iso];
      const lo = Math.max(-50, mu - 20);
      const hi = Math.min(140, mu + 20);

      for (let t = lo; t <= hi; t += 1) {
        const opt = document.createElement("option");
        opt.value = String(t);
        opt.textContent = String(t);
        elTempSel.appendChild(opt);
      }

      elTempSel.disabled = false;
      elTempSel.value = String(Math.round(mu));
      updateAddEnabled();
    }

    async function loadHighs() {
      clearError();
      setStatus("loading", "run");
      btnHighs.disabled = true;
      btnAdd.disabled = true;

      highs = {};
      elHighsBody.innerHTML = "";
      elHighsTable.style.display = "none";
      hCount.textContent = "0";

      elResultsBody.innerHTML = "";
      elResultsTable.style.display = "none";
      rCount.textContent = "0";

      elDateSel.disabled = true;
      elTempSel.disabled = true;
      elDateSel.innerHTML = `<option value="">—</option>`;
      elTempSel.innerHTML = `<option value="">—</option>`;

      try {
        const code = elCity.value;
        const r = await fetch(`${API_BASE}/api/highs?city=${encodeURIComponent(code)}`);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        const list = data.highs || [];

        for (const row of list) highs[row.date] = row.high_f;

        for (const iso of Object.keys(highs).sort()) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td class="mono">${iso}</td><td>${highs[iso]}</td>`;
          elHighsBody.appendChild(tr);
        }
        elHighsTable.style.display = list.length ? "table" : "none";
        hCount.textContent = String(list.length);

        populateDateDropdown();
        populateTempDropdownForDate();
        setStatus("ready", "ok");
      } catch (e) {
        showError(`Load failed\n\n${e}`);
      } finally {
        btnHighs.disabled = false;
      }
    }

    function addLine() {
      const iso = elDateSel.value;
      const t = Number(elTempSel.value);
      const yes = parseNum(elYes.value);
      const no = parseNum(elNo.value);
      if (!iso || !Number.isFinite(t) || yes === null || no === null) return;

      const mdy = isoToMDY(iso);
      const line = `${mdy} - ${t} - yes:${yes} / no:${no}`;

      if (!builtLines.includes(line)) builtLines.push(line);
      rebuildQueue();

      elYes.value = "";
      elNo.value = "";
      updateAddEnabled();
      setStatus("added", "ok");
    }

    function clearAll() {
      builtLines = [];
      rebuildQueue();
      elResultsBody.innerHTML = "";
      elResultsTable.style.display = "none";
      rCount.textContent = "0";
      setStatus("idle", "idle");
      clearError();
    }

    function sigBadge(sig) {
      const x = (sig || "").toUpperCase();
      if (x.includes("BUY YES")) return `<span class="signal buyyes"><span class="s-dot"></span>BUY YES</span>`;
      if (x.includes("BUY NO"))  return `<span class="signal buyno"><span class="s-dot"></span>BUY NO</span>`;
      return `<span class="signal pass"><span class="s-dot"></span>PASS</span>`;
    }

    async function evaluate() {
      clearError();
      elResultsBody.innerHTML = "";
      elResultsTable.style.display = "none";
      rCount.textContent = "0";

      if (!builtLines.length) {
        setStatus("queue empty", "warn");
        return;
      }

      setStatus("running", "run");
      btnEval.disabled = true;

      try {
        const code = elCity.value;
        const r = await fetch(`${API_BASE}/api/evaluate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ city: code, lines: builtLines })
        });
        if (!r.ok) {
          const text = await r.text();
          throw new Error(`HTTP ${r.status}\n${text}`);
        }
        const data = await r.json();
        const results = data.results || [];

        for (const x of results) {
          if (x.error) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="mono">${(x.raw || "").replace(/</g,"&lt;")}</td>
              <td colspan="5" class="mono" style="color:rgba(255,220,227,.95);"> ${String(x.error).replace(/</g,"&lt;")} </td>
            `;
            elResultsBody.appendChild(tr);
            continue;
          }

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="mono">${x.date} ≥ ${x.t}F</td>
            <td class="mono">Y ${x.market_yes.toFixed(4)}<br><span class="muted">N ${x.market_no.toFixed(4)}</span></td>
            <td class="mono">μ ${x.mu.toFixed(1)}<br><span class="muted">σ ${x.sigma.toFixed(1)}</span></td>
            <td class="mono">${x.fair_yes.toFixed(4)}<br><span class="muted">${x.fair_no.toFixed(4)}</span></td>
            <td class="mono">${x.edge_yes.toFixed(4)}<br><span class="muted">${x.edge_no.toFixed(4)}</span></td>
            <td>${sigBadge(x.signal)}</td>
          `;
          elResultsBody.appendChild(tr);
        }

        elResultsTable.style.display = results.length ? "table" : "none";
        rCount.textContent = String(results.length);

        // Summary status: if any BUY, show ok; else warn.
        const anyBuy = results.some(r => (r.signal || "").toUpperCase().includes("BUY"));
        setStatus(anyBuy ? "signal" : "pass", anyBuy ? "ok" : "warn");
      } catch (e) {
        showError(`Run failed\n\n${e}`);
      } finally {
        btnEval.disabled = false;
      }
    }

    // Events
    elCity.addEventListener("change", () => { setPills(); });
    btnHighs.addEventListener("click", loadHighs);
    btnAdd.addEventListener("click", addLine);
    btnClear.addEventListener("click", clearAll);
    btnEval.addEventListener("click", evaluate);

    elDateSel.addEventListener("change", () => {
      populateTempDropdownForDate();
      updateAddEnabled();
    });
    elTempSel.addEventListener("change", updateAddEnabled);
    elYes.addEventListener("input", updateAddEnabled);
    elNo.addEventListener("input", updateAddEnabled);

    // Init
    setPills();
    rebuildQueue();
    setStatus("idle", "idle");
  </script>
</body>
</html>
