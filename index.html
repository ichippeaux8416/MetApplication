<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>High Temperature Prediction Market Guidance</title>
  <style>
    :root{
      --bg:#0a0c10;
      --text:#e9eef7;
      --muted:#a0aec2;
      --blue:#7fb4ff;
      --good:#2cc38a;
      --warn:#f3c969;
      --bad:#ff6b6b;
      --shadow: 0 16px 55px rgba(0,0,0,.45);
      --radius:10px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;}
    .wrap{max-width:1180px;margin:0 auto;padding:26px 18px 44px}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;padding-bottom:18px;border-bottom:1px solid rgba(255,255,255,.08);}
    .brand{display:flex;flex-direction:column;gap:8px}
    .brand h1{margin:0;font-size:48px;font-weight:900;letter-spacing:.18em;line-height:1;color:var(--text);}
    .sub{color:var(--muted);font-weight:800;letter-spacing:.08em;font-size:13px;}
    .nav{display:flex;gap:10px;justify-content:flex-end; padding-top:6px;}
    .nav a{color:var(--text);text-decoration:none;font-weight:900;padding:10px 12px;border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.03);border-radius: 12px;}
    .nav a:hover{border-color: rgba(127,180,255,.35)}
    .grid{display:grid;grid-template-columns: 1.1fr 1fr;gap:18px;margin-top:22px;}
    .card{background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.10);border-radius: var(--radius);box-shadow: var(--shadow);overflow:hidden;}
    .card-h{padding:16px 16px 12px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;letter-spacing:.14em;font-weight:900;color:#c2cde0;text-transform:uppercase;font-size:12px;}
    .card-b{padding:16px}
    .row{display:grid;grid-template-columns: 1fr 1fr;gap:14px;}
    label{display:block;color:#c2cde0;font-weight:900;letter-spacing:.12em;text-transform:uppercase;font-size:12px;margin-bottom:10px;}
    select, input{width:100%;padding:16px 14px;border-radius: 10px;border:1px solid rgba(255,255,255,.12);background: rgba(10,14,20,.85);color: var(--text);outline:none;font-size:18px;}
    select:focus, input:focus{border-color: rgba(127,180,255,.55)}
    .btn{width:100%;margin-top:14px;padding:16px 16px;border-radius: 10px;border:1px solid rgba(127,180,255,.65);background: rgba(127,180,255,.18);color: var(--text);font-weight:900;font-size:18px;letter-spacing:.04em;cursor:pointer;}
    .btn:hover{filter:brightness(1.05)}
    .status{display:flex;align-items:center;gap:10px;margin-top:14px;color: var(--muted);font-weight:800;}
    .dot{width:10px;height:10px;border-radius:999px;background:#667;box-shadow:0 0 0 3px rgba(255,255,255,.05)}
    .dot.ok{background: var(--good)}
    .dot.err{background: var(--bad)}
    .dot.busy{background: var(--blue)}
    .big{font-size:56px;font-weight:900;letter-spacing:.02em;margin:6px 0 0;}
    .subtitle{color:var(--muted);font-weight:800;letter-spacing:.01em;margin-top:6px;font-size:16px;}
    .miniGrid{display:grid;grid-template-columns: 1fr 1fr;gap:12px;margin-top:14px;}
    .mini{border:1px solid rgba(255,255,255,.10);background: rgba(10,14,20,.55);border-radius: 12px;padding:12px;}
    .mini h4{margin:0 0 8px;letter-spacing:.14em;font-weight:900;text-transform:uppercase;color:#c2cde0;font-size:12px;}
    .mini .val{font-size:14px;font-weight:900;color: var(--text);line-height:1.35;word-break: break-word;}
    .chartWrap{margin-top:14px;border:1px solid rgba(255,255,255,.10);background: rgba(10,14,20,.55);border-radius: 12px;padding:12px;position:relative;}
    .legend{position:absolute;top:10px;right:12px;display:flex;gap:12px;align-items:center;font-weight:900;font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#c2cde0;background: rgba(10,14,20,.65);border:1px solid rgba(255,255,255,.10);padding:8px 10px;border-radius: 10px;}
    .sw{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px;}
    .sw.fair{background: var(--blue)}
    .sw.you{background: var(--warn)}
    canvas{width:100%;height:280px;display:block}

    .hrrrList{margin-top:12px;border:1px solid rgba(255,255,255,.10);background: rgba(10,14,20,.55);border-radius: 12px;padding:12px;}
    .hrrrList h4{margin:0 0 10px;letter-spacing:.14em;font-weight:900;text-transform:uppercase;color:#c2cde0;font-size:12px;}
    .hrrrRow{display:flex;justify-content:space-between;gap:12px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.07);}
    .hrrrRow:last-child{border-bottom:none;}
    .hrrrT{color:var(--muted);font-weight:900;font-size:12px;letter-spacing:.08em;text-transform:uppercase;}
    .hrrrV{font-weight:900;display:flex;gap:10px;align-items:center;}
    .badge{
      font-size:11px;
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      border:1px solid rgba(255,255,255,.14);
      padding:3px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      color:#cfe2ff;
      white-space:nowrap;
    }

    .riskBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:11px;
    }
    .riskDot{width:10px;height:10px;border-radius:999px;background:#667}
    .riskDot.vlow{background: var(--good)}
    .riskDot.low{background: rgba(44,195,138,.65)}
    .riskDot.med{background: var(--warn)}
    .riskDot.high{background: var(--bad)}

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand h1{font-size:36px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>MetApplication</h1>
        <div class="sub">HIGH TEMPERATURE PREDICTION MARKET GUIDANCE</div>
      </div>
      <div class="nav">
        <a href="/drought.html">Drought Odds</a>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="card-h">
          <div>Inputs</div>
          <div id="cityTag" style="font-weight:900;letter-spacing:.14em;color:#c2cde0;text-transform:uppercase;">—</div>
        </div>
        <div class="card-b">
          <div class="row">
            <div>
              <label for="city">City</label>
              <select id="city">
                <option value="den">Denver</option>
                <option value="nyc">New York City</option>
                <option value="dal">Dallas</option>
                <option value="chi">Chicago</option>
              </select>
            </div>
            <div>
              <label for="date">Date</label>
              <select id="date"></select>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div>
              <label for="t">Potential High Temp</label>
              <select id="t"></select>
            </div>
            <div>
              <label for="yes">Yes Cost</label>
              <input id="yes" inputmode="decimal" placeholder="e.g. 32" />
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div>
              <label for="no">No Cost</label>
              <input id="no" inputmode="decimal" placeholder="e.g. 68" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn" id="go">Evaluate Market</button>
            </div>
          </div>

          <div class="miniGrid" style="margin-top:14px;">
            <div class="mini">
              <h4>Local Time</h4>
              <div class="val" id="localTime">—</div>
            </div>
            <div class="mini">
              <h4>Current Temp</h4>
              <div class="val" id="currentTemp">—</div>
            </div>
          </div>

          <div class="hrrrList">
            <h4>HRRR 2m temperature — next 12 hours</h4>
            <div id="hrrrMeta" class="hrrrRow" style="border-bottom:1px solid rgba(255,255,255,.07);padding-bottom:10px;margin-bottom:6px;">
              <div class="hrrrT">Status</div><div class="hrrrV" id="hrrrStatus">—</div>
            </div>
            <div id="hrrrBody">
              <div class="hrrrRow"><div class="hrrrT">—</div><div class="hrrrV">—</div></div>
            </div>
          </div>

          <div class="status" id="status">
            <span class="dot ok" id="dot"></span>
            <span id="statusText">Ready</span>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-h">
          <div>Result</div>
          <div id="cityTop" style="font-weight:900;letter-spacing:.14em;color:#c2cde0;text-transform:uppercase;">—</div>
        </div>
        <div class="card-b">
          <div class="big" id="signal">—</div>
          <div class="subtitle" id="subline">—</div>

          <div class="miniGrid">
            <div class="mini">
              <h4>Fair Yes</h4>
              <div class="val" id="fairYes">—</div>
            </div>
            <div class="mini">
              <h4>Fair No</h4>
              <div class="val" id="fairNo">—</div>
            </div>
            <div class="mini">
              <h4>Your Yes</h4>
              <div class="val" id="yourYes">—</div>
            </div>
            <div class="mini">
              <h4>Your No</h4>
              <div class="val" id="yourNo">—</div>
            </div>
          </div>

          <div class="miniGrid" style="margin-top:12px;">
            <div class="mini">
              <h4>HRRR vs NWS Risk</h4>
              <div class="val" id="riskBox">—</div>
            </div>
            <div class="mini">
              <h4>HRRR High (12h)</h4>
              <div class="val" id="hrrrHighBox">—</div>
            </div>
          </div>

          <div class="chartWrap">
            <div class="legend">
              <span><span class="sw fair"></span>Fair Price</span>
              <span><span class="sw you"></span>Your Price</span>
            </div>
            <canvas id="chart" width="900" height="280"></canvas>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  const cityNames = { den:"Denver", nyc:"New York City", dal:"Dallas", chi:"Chicago" };

  let latestHighs = [];
  let latestMu = null;
  let latestSigma = null;

  // HRRR cache (from /api/hrrr_four)
  let hrrrFour = null;     // full payload
  let hrrrTz = null;       // tz string from /api/now for selected city
  let hrrrHigh12 = null;   // numeric max temp in displayed series (selected city)

  function setStatus(kind, text){
    const dot = $("dot");
    dot.className = "dot " + (kind || "ok");
    $("statusText").textContent = text;
  }

  function pct(x){
    if (x === null || x === undefined || Number.isNaN(x)) return "—";
    return (x*100).toFixed(1) + "%";
  }
  function money(x){
    if (x === null || x === undefined || Number.isNaN(x)) return "—";
    return (x*100).toFixed(1) + "¢";
  }

  function populateTemps(){
    const sel = $("t");
    sel.innerHTML = "";
    for(let f=40; f<=110; f+=1){
      const o = document.createElement("option");
      o.value = String(f);
      o.textContent = String(f) + "°F";
      sel.appendChild(o);
    }
    sel.value = "73";
  }

  function populateDates(){
    const sel = $("date");
    sel.innerHTML = "";
    for(const h of latestHighs){
      const o = document.createElement("option");
      o.value = h.date;
      o.textContent = h.date;
      sel.appendChild(o);
    }
  }

  async function loadHighs(){
    const city = $("city").value;
    $("cityTag").textContent = (cityNames[city] || "—").toUpperCase();
    $("cityTop").textContent = (cityNames[city] || "—").toUpperCase();

    setStatus("busy", "Loading…");
    try{
      const res = await fetch(`/api/highs?city=${encodeURIComponent(city)}`);
      const data = await res.json();
      if(data.error){
        setStatus("err", data.error);
        return;
      }
      latestHighs = data.highs || [];
      populateDates();
      setStatus("ok", "Ready");
    }catch(e){
      setStatus("err", "Network error");
    }
  }

  function formatLocal(dtIsoUtc, tz){
    try{
      const d = new Date(dtIsoUtc);
      const fmt = new Intl.DateTimeFormat(undefined, {
        timeZone: tz,
        weekday:"short",
        hour:"numeric",
        minute:"2-digit",
        month:"short",
        day:"numeric"
      });
      return fmt.format(d);
    }catch(e){
      return (dtIsoUtc || "—").replace("T"," ").replace("Z"," UTC");
    }
  }

  async function refreshNowPanel(){
    const city = $("city").value;
    try{
      const res = await fetch(`/api/now?city=${encodeURIComponent(city)}`);
      const data = await res.json();
      if(data.error){
        $("localTime").textContent = "—";
        $("currentTemp").textContent = "—";
        hrrrTz = null;
        return;
      }

      hrrrTz = data.tz || null;

      // Show nice local time if tz exists, else fallback to obs timestamp
      if(hrrrTz){
        $("localTime").textContent = formatLocal(new Date().toISOString(), hrrrTz);
      }else{
        const tz = data.tz || "—";
        const obs = data.obs_time || data.server_utc || "—";
        $("localTime").textContent = `${obs} (${tz})`;
      }

      if(typeof data.temp_f === "number"){
        $("currentTemp").textContent = `${data.temp_f.toFixed(1)}°F`;
      }else{
        $("currentTemp").textContent = "—";
      }
    }catch(e){
      $("localTime").textContent = "—";
      $("currentTemp").textContent = "—";
      hrrrTz = null;
    }
  }

  async function loadHrrrFour(hours=12){
    $("hrrrStatus").textContent = "Loading…";
    try{
      const res = await fetch(`/api/hrrr_four?hours=${encodeURIComponent(hours)}`);
      const data = await res.json();
      if(data.error){
        hrrrFour = null;
        $("hrrrStatus").textContent = data.error;
        return;
      }
      hrrrFour = data;
      const asof = data.asof_utc ? data.asof_utc.replace("T"," ").replace("Z"," UTC") : "—";
      $("hrrrStatus").textContent = `OK · asof ${asof}`;
    }catch(e){
      hrrrFour = null;
      $("hrrrStatus").textContent = "Network error";
    }
  }

  function renderHrrrSelectedCity(){
    const city = $("city").value;
    const body = $("hrrrBody");
    body.innerHTML = "";

    hrrrHigh12 = null;
    $("hrrrHighBox").textContent = "—";

    if(!hrrrFour || !hrrrFour.cities || !hrrrFour.cities[city]){
      const el = document.createElement("div");
      el.className = "hrrrRow";
      el.innerHTML = `<div class="hrrrT">HRRR</div><div class="hrrrV">hrrr_unavailable</div>`;
      body.appendChild(el);
      return;
    }

    const series = hrrrFour.cities[city].series || [];
    if(!series.length){
      const el = document.createElement("div");
      el.className = "hrrrRow";
      el.innerHTML = `<div class="hrrrT">HRRR</div><div class="hrrrV">No data</div>`;
      body.appendChild(el);
      return;
    }

    // Determine max temp in list (forecast high over next 12h)
    let maxT = -1e9;
    for(const r of series){
      if(typeof r.temp_f === "number") maxT = Math.max(maxT, r.temp_f);
    }
    if(isFinite(maxT)) hrrrHigh12 = maxT;

    if(typeof hrrrHigh12 === "number"){
      $("hrrrHighBox").textContent = `${hrrrHigh12.toFixed(1)}°F`;
    }

    // Render rows; mark the max value with a badge
    for(const r of series){
      const tLocal = (hrrrTz && r.valid_utc) ? formatLocal(r.valid_utc, hrrrTz) : (r.valid_utc || "—");
      const v = (typeof r.temp_f === "number") ? r.temp_f.toFixed(1)+"°F" : "—";
      const isHigh = (typeof r.temp_f === "number" && typeof hrrrHigh12 === "number" && Math.abs(r.temp_f - hrrrHigh12) < 0.05);

      const el = document.createElement("div");
      el.className = "hrrrRow";
      el.innerHTML = `
        <div class="hrrrT">${tLocal}</div>
        <div class="hrrrV">
          <span>${v}</span>
          ${isHigh ? `<span class="badge">Forecast high</span>` : ``}
        </div>`;
      body.appendChild(el);
    }
  }

  // ---- Chart (same math as backend) ----
  function erf(x){
    const sign = x >= 0 ? 1 : -1;
    x = Math.abs(x);
    const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;
    const t = 1/(1+p*x);
    const y = 1 - (((((a5*t+a4)*t)+a3)*t+a2)*t+a1)*t*Math.exp(-x*x);
    return sign*y;
  }
  function normCdf(x){ return 0.5*(1+erf(x/Math.sqrt(2))); }
  function probGE(mu,sigma,thr){
    if(!(sigma>0)) return mu>=thr ? 1 : 0;
    const z = (thr - 0.5 - mu)/sigma;
    return Math.max(0, Math.min(1, 1 - normCdf(z)));
  }

  function drawChart(mu, sigma, yourP, tVal){
    const c = $("chart");
    const ctx = c.getContext("2d");
    const w = c.width, h = c.height;

    ctx.clearRect(0,0,w,h);

    const padL = 54, padR = 22, padT = 18, padB = 36;
    const plotW = w - padL - padR;
    const plotH = h - padT - padB;

    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1;

    ctx.fillStyle = "rgba(255,255,255,.35)";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    for(let i=0;i<=4;i++){
      const y = padT + (plotH * (i/4));
      ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL+plotW, y); ctx.stroke();
      const p = (1 - i/4);
      ctx.fillText(Math.round(p*100)+"%", 10, y+4);
    }

    const t0 = Math.max(30, tVal - 10);
    const t1 = Math.min(120, tVal + 10);

    ctx.fillStyle = "rgba(255,255,255,.35)";
    for(let i=0;i<=4;i++){
      const x = padL + (plotW * (i/4));
      const tv = Math.round(t0 + (t1-t0)*(i/4));
      ctx.fillText(tv+"°", x-10, padT+plotH+24);
    }

    ctx.strokeStyle = "rgba(255,255,255,.18)";
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT+plotH);
    ctx.lineTo(padL+plotW, padT+plotH);
    ctx.stroke();

    ctx.lineWidth = 3;
    ctx.strokeStyle = "rgba(127,180,255,.95)";
    ctx.beginPath();
    for(let i=0;i<=160;i++){
      const thr = t0 + (t1-t0)*(i/160);
      const p = probGE(mu, sigma, thr);
      const x = padL + (plotW * ((thr - t0)/(t1-t0)));
      const y = padT + (plotH * (1 - p));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    const fairAtT = probGE(mu, sigma, tVal);

    const xP = padL + (plotW * ((tVal - t0)/(t1-t0)));
    const yF = padT + (plotH * (1 - fairAtT));
    ctx.fillStyle = "rgba(127,180,255,.95)";
    ctx.beginPath(); ctx.arc(xP, yF, 5, 0, Math.PI*2); ctx.fill();

    const yP = padT + (plotH * (1 - Math.max(0, Math.min(1, yourP))));
    ctx.fillStyle = "rgba(243,201,105,.95)";
    ctx.beginPath(); ctx.arc(xP, yP, 6, 0, Math.PI*2); ctx.fill();

    return fairAtT;
  }

  function riskFromDelta(signal, delta){
    // delta = HRRR_high - NWS_high
    if(!isFinite(delta)) return null;

    const s = (signal || "").toUpperCase();
    let level = null;

    if(s === "BUY YES"){
      // HRRR lower than NWS => worse for YES
      if(delta <= -2) level = "high";
      else if(delta === -1) level = "med";
      else if(delta === 0) level = "low";
      else if(delta >= 1) level = "vlow";
      else level = "med";
    } else if(s === "BUY NO"){
      // HRRR higher than NWS => worse for NO
      if(delta >= 2) level = "high";
      else if(delta === 1) level = "med";
      else if(delta === 0) level = "low";
      else if(delta <= -1) level = "vlow";
      else level = "med";
    } else {
      return null;
    }
    return level;
  }

  function riskLabel(level){
    if(level === "vlow") return "Very low risk";
    if(level === "low") return "Low risk";
    if(level === "med") return "Medium risk";
    if(level === "high") return "High risk";
    return "—";
  }

  function renderRisk(signal, nwsHigh){
    const box = $("riskBox");
    if(typeof hrrrHigh12 !== "number" || typeof nwsHigh !== "number"){
      box.textContent = "—";
      return;
    }

    const delta = Math.round((hrrrHigh12 - nwsHigh) * 10) / 10;
    const level = riskFromDelta(signal, delta);

    if(!level){
      box.textContent = "—";
      return;
    }

    box.innerHTML = `
      <span class="riskBadge">
        <span class="riskDot ${level}"></span>
        ${riskLabel(level)}
      </span>
      <span style="margin-left:10px;color:rgba(255,255,255,.55);font-weight:900;">
        Δ(HRRR−NWS) ${delta > 0 ? "+" : ""}${delta.toFixed(1)}°F
      </span>
    `;
  }

  async function refreshHrrrUI(){
    // ensure we have tz first for local formatting, then ensure HRRR loaded
    await refreshNowPanel();
    if(!hrrrFour){
      await loadHrrrFour(12);
    }
    renderHrrrSelectedCity();
  }

  async function evaluate(){
    const city = $("city").value;
    const date = $("date").value;
    const t = parseFloat($("t").value);
    const yes = parseFloat($("yes").value);
    const no = parseFloat($("no").value);

    if(!date || Number.isNaN(t) || Number.isNaN(yes) || Number.isNaN(no)){
      setStatus("err", "Missing inputs");
      return;
    }

    setStatus("busy", "Evaluating…");

    try{
      const res = await fetch("/api/evaluate_one", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ city, date, threshold_f: t, yes_cents: yes, no_cents: no })
      });

      const data = await res.json();
      if(data.error){
        setStatus("err", data.error);
        $("signal").textContent = "—";
        $("subline").textContent = "—";
        $("fairYes").textContent = "—";
        $("fairNo").textContent = "—";
        $("yourYes").textContent = "—";
        $("yourNo").textContent = "—";
        $("riskBox").textContent = "—";
        drawChart(70, 7.5, 0.5, t);
        return;
      }

      const fairYes = data.fair_yes;
      const fairNo = data.fair_no;
      const yourYes = data.market_yes;
      const yourNo = data.market_no;

      latestMu = (typeof data.mu === "number") ? data.mu : null;
      latestSigma = (typeof data.sigma === "number") ? data.sigma : null;

      $("signal").textContent = data.signal;

      const muTxt = (typeof data.mu === "number") ? `${data.mu.toFixed(1)}°F` : "—";
      const muF = (typeof data.mu_forecast_high === "number") ? `${data.mu_forecast_high.toFixed(1)}°F` : "—";
      $("subline").textContent = `Fair YES ${pct(fairYes)} · μ(nowcast) ${muTxt} · μ(NWS high) ${muF}`;

      $("fairYes").textContent = pct(fairYes);
      $("fairNo").textContent = pct(fairNo);
      $("yourYes").textContent = money(yourYes);
      $("yourNo").textContent = money(yourNo);

      const muForChart = (latestMu ?? 70);
      const sgForChart = (latestSigma ?? 7.5);
      drawChart(muForChart, sgForChart, yourYes, t);

      // Ensure HRRR UI is up-to-date before risk calc
      await refreshHrrrUI();

      const nwsHigh = (typeof data.mu_forecast_high === "number") ? data.mu_forecast_high : null;
      renderRisk(data.signal, nwsHigh);

      setStatus("ok", "OK");
    }catch(e){
      setStatus("err", "Network error");
    }
  }

  $("city").addEventListener("change", async ()=>{
    await loadHighs();
    await refreshHrrrUI();
  });

  $("go").addEventListener("click", evaluate);

  (function init(){
    populateTemps();
    loadHighs().then(async ()=>{
      $("cityTag").textContent = (cityNames[$("city").value] || "—").toUpperCase();
      $("cityTop").textContent = (cityNames[$("city").value] || "—").toUpperCase();
      await loadHrrrFour(12);
      await refreshHrrrUI();
      $("riskBox").textContent = "—";
      drawChart(70, 7.5, 0.5, 73);
    });
  })();
</script>
</body>
</html>
