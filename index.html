<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MetApplication</title>
  <style>
    :root{
      --bg:#07090d;
      --panel:#0e141f;
      --panel2:#0b1018;
      --line:#1c2432;
      --line2:#223047;
      --text:#e7eefc;
      --muted:#9aa7bf;
      --blue:#60a5ff;
      --blue2:#9cc7ff;
      --warn:#f3c969;
      --bad:#ff6b6b;
      --ok:#3ddc97;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 15% 10%, rgba(96,165,255,.10), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(156,199,255,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      letter-spacing:.2px;
    }
    .topbar{
      display:flex; align-items:flex-end; justify-content:space-between;
      padding:28px 28px 18px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .brand{
      display:flex; flex-direction:column; gap:6px;
    }
    .brand .title{
      font-size:44px;
      font-weight:800;
      letter-spacing:6px;
      line-height:1;
    }
    .brand .sub{
      margin-top:-2px;
      color:rgba(231,238,252,.65);
      font-size:12px;
      letter-spacing:2.2px;
      font-weight:700;
    }
    .wrap{padding:22px 28px 36px; max-width:1200px; margin:0 auto;}
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:18px;
      margin-top:18px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 18px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.06);
      color:rgba(231,238,252,.7);
      font-weight:800;
      letter-spacing:2px;
      font-size:12px;
      text-transform:uppercase;
    }
    .card .bd{padding:18px;}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:14px;}
    label{
      display:block;
      margin-bottom:8px;
      color:rgba(231,238,252,.65);
      font-weight:800;
      font-size:12px;
      letter-spacing:1.8px;
      text-transform:uppercase;
    }
    select,input{
      width:100%;
      background: rgba(6,10,16,.65);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      padding:14px 14px;
      border-radius:12px;
      outline:none;
      font-size:18px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
    }
    input::placeholder{color:rgba(231,238,252,.25)}
    .btn{
      margin-top:14px;
      width:100%;
      padding:16px 16px;
      border-radius:12px;
      border:1px solid rgba(96,165,255,.45);
      background: rgba(96,165,255,.18);
      color:var(--text);
      font-weight:800;
      letter-spacing:1px;
      font-size:18px;
      cursor:pointer;
    }
    .btn:hover{background: rgba(96,165,255,.26)}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(6,10,16,.55);
      font-weight:900;
      letter-spacing:1px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--warn);
      box-shadow:0 0 0 4px rgba(243,201,105,.12);
    }
    .dot.ok{background:var(--ok); box-shadow:0 0 0 4px rgba(61,220,151,.12);}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 4px rgba(255,107,107,.12);}
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .kv{
      padding:14px 16px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      background: rgba(6,10,16,.50);
      margin-top:12px;
    }
    .kv .k{
      color:rgba(231,238,252,.55);
      font-weight:900;
      letter-spacing:2px;
      font-size:12px;
      text-transform:uppercase;
      margin-bottom:10px;
    }
    .kv .v{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      font-size:22px;
      font-weight:800;
    }
    .small{
      color:rgba(231,238,252,.55);
      font-size:12px;
      font-weight:700;
      letter-spacing:1px;
      margin-top:10px;
    }
    canvas{width:100%; height:240px; display:block;}
    .chartBox{
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      overflow:hidden;
      background: rgba(6,10,16,.45);
      padding:12px 12px 6px;
    }
    .legend{
      display:flex;
      justify-content:flex-end;
      gap:22px;
      padding:6px 6px 10px;
      color:rgba(231,238,252,.75);
      font-weight:900;
      letter-spacing:2px;
      font-size:12px;
      text-transform:uppercase;
    }
    .legItem{display:flex; align-items:center; gap:10px;}
    .swatch{width:14px;height:14px;border-radius:6px;background:var(--blue);}
    .swatch2{background: rgba(156,199,255,.85); border:1px solid rgba(255,255,255,.18);}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand .title{font-size:38px; letter-spacing:5px;}
    }

    /* ---- ONLY ADDITION: drought button styling ---- */
    .navbtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:12px 16px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(6,10,16,.55);
      color: rgba(231,238,252,.92);
      text-decoration:none;
      font-weight:900;
      letter-spacing:1.2px;
      font-size:12px;
      text-transform:uppercase;
    }
    .navbtn:hover{
      background: rgba(6,10,16,.72);
      border-color: rgba(96,165,255,.30);
    }
    /* ---------------------------------------------- */
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="title">MetApplication</div>
      <div class="sub">HIGH TEMPERATURE PREDICTION MARKET GUIDANCE</div>
    </div>

    <!-- ONLY CHANGE: one button that links to drought.html -->
    <a class="navbtn" href="/drought.html">Long Term Drought Odds</a>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Inputs -->
      <div class="card">
        <div class="hd">
          <div>Inputs</div>
          <div class="mono" style="opacity:.65">Evaluate Market</div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>City</label>
              <select id="city">
                <option value="den">Denver</option>
                <option value="nyc">New York City</option>
                <option value="dal">Dallas</option>
                <option value="chi">Chicago</option>
              </select>
            </div>
            <div>
              <label>Date</label>
              <input id="date" placeholder="MM/DD/YYYY" />
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div>
              <label>Potential High Temp</label>
              <input id="temp" type="number" step="1" placeholder="e.g. 42" />
            </div>
            <div>
              <label>Yes Cost</label>
              <input id="yes" type="number" step="0.1" placeholder="cents (e.g. 30)" />
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div>
              <label>No Cost</label>
              <input id="no" type="number" step="0.1" placeholder="cents (e.g. 70)" />
            </div>
            <div>
              <button class="btn" id="go">Evaluate Market</button>
            </div>
          </div>

          <div class="small mono" id="status"></div>
        </div>
      </div>

      <!-- Result -->
      <div class="card">
        <div class="hd">
          <div>Result</div>
          <div id="cityName" class="mono" style="opacity:.65">—</div>
        </div>
        <div class="bd">
          <div class="chartBox">
            <div class="legend">
              <div class="legItem"><span class="swatch"></span><span>Fair Price</span></div>
              <div class="legItem"><span class="swatch swatch2"></span><span>Your Price</span></div>
            </div>
            <canvas id="chart" width="900" height="300"></canvas>
          </div>

          <div style="margin-top:14px;">
            <span class="pill" id="signalPill">
              <span class="dot" id="sigDot"></span>
              <span id="signalTxt">PASS</span>
            </span>
          </div>

          <div class="kv">
            <div class="k">Contract</div>
            <div class="v mono" id="contractLine">—</div>
          </div>

          <div class="kv">
            <div class="k">Market</div>
            <div class="v mono" id="marketLine">—</div>
          </div>

          <div class="kv">
            <div class="k">Model</div>
            <div class="v mono" id="modelLine">—</div>
          </div>

          <div class="kv">
            <div class="k">Fair</div>
            <div class="v mono" id="fairLine">—</div>
          </div>

          <div class="kv">
            <div class="k">Edge</div>
            <div class="v mono" id="edgeLine">—</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  const chart = $("chart");
  const ctx = chart.getContext("2d");

  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

  function drawChart(mu, sigma, t, fairAtT, yourYesPrice){
    const w = chart.width, h = chart.height;
    ctx.clearRect(0,0,w,h);

    const padL = 58, padR = 20, padT = 18, padB = 40;
    const iw = w - padL - padR;
    const ih = h - padT - padB;

    const xmin = Math.floor(mu - 4*sigma);
    const xmax = Math.ceil(mu + 4*sigma);

    function xToPx(x){ return padL + ( (x - xmin) / (xmax - xmin) ) * iw; }
    function yToPx(y){ return padT + (1 - y) * ih; }

    ctx.globalAlpha = 1;
    ctx.strokeStyle = "rgba(255,255,255,0.06)";
    ctx.lineWidth = 1;
    for(let i=0;i<=6;i++){
      const gx = padL + (i/6)*iw;
      ctx.beginPath(); ctx.moveTo(gx,padT); ctx.lineTo(gx,padT+ih); ctx.stroke();
    }
    for(let i=0;i<=4;i++){
      const gy = padT + (i/4)*ih;
      ctx.beginPath(); ctx.moveTo(padL,gy); ctx.lineTo(padL+iw,gy); ctx.stroke();
    }

    ctx.fillStyle = "rgba(231,238,252,0.65)";
    ctx.font = "bold 12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
    ctx.textAlign = "center";
    ctx.fillText(`${xmin}°F`, xToPx(xmin), padT+ih+28);
    ctx.fillText(`${Math.round(mu)}°F`, xToPx(mu), padT+ih+28);
    ctx.fillText(`${xmax}°F`, xToPx(xmax), padT+ih+28);

    ctx.textAlign = "right";
    ctx.fillText("1.0", padL-10, yToPx(1.0)+4);
    ctx.fillText("0.5", padL-10, yToPx(0.5)+4);
    ctx.fillText("0.0", padL-10, yToPx(0.0)+4);

    const k = sigma*0.85 || 1.0;
    function fairCurve(x){
      const z = (x - mu) / k;
      return 1/(1+Math.exp(z));
    }

    ctx.strokeStyle = "rgba(96,165,255,0.95)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    for(let i=0;i<=200;i++){
      const x = xmin + (i/200)*(xmax-xmin);
      const y = clamp(fairCurve(x),0,1);
      const px = xToPx(x), py = yToPx(y);
      if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    }
    ctx.stroke();

    const pxT = xToPx(t);
    const pyYour = yToPx(clamp(yourYesPrice,0,1));

    ctx.fillStyle = "rgba(156,199,255,0.18)";
    ctx.beginPath(); ctx.arc(pxT, pyYour, 14, 0, Math.PI*2); ctx.fill();

    ctx.fillStyle = "rgba(156,199,255,0.90)";
    ctx.strokeStyle = "rgba(255,255,255,0.20)";
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(pxT, pyYour, 7, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    const pyFair = yToPx(clamp(fairAtT,0,1));
    ctx.strokeStyle = "rgba(96,165,255,0.35)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(pxT, pyFair);
    ctx.lineTo(pxT, padT+ih);
    ctx.stroke();
  }

  function setSignal(sig){
    const dot = $("sigDot");
    const txt = $("signalTxt");
    txt.textContent = sig;

    dot.classList.remove("ok","bad");
    if(sig === "BUY YES" || sig === "BUY NO"){
      dot.classList.add("ok");
    } else if(sig === "PASS"){
      // keep warn color
    } else {
      dot.classList.add("bad");
    }
  }

  function fmt4(x){
    if(x === null || x === undefined || Number.isNaN(x)) return "—";
    return (Math.round(x*10000)/10000).toFixed(4);
  }

  async function evaluate(){
    $("status").textContent = "";

    const city = $("city").value;
    const date = $("date").value.trim();
    const t = parseFloat($("temp").value);
    const yesC = parseFloat($("yes").value);
    const noC = parseFloat($("no").value);

    if(!date){ $("status").textContent = "Enter Date."; return; }
    if(!Number.isFinite(t)){ $("status").textContent = "Enter Potential High Temp."; return; }
    if(!Number.isFinite(yesC) || !Number.isFinite(noC)){ $("status").textContent = "Enter Yes/No Cost in cents."; return; }

    $("contractLine").textContent = `${date} — ${t} — yes:${yesC} / no:${noC}`;
    $("marketLine").textContent = `YES ${(yesC/100).toFixed(4)} | NO ${(noC/100).toFixed(4)}`;

    let resp, data;
    try{
      resp = await fetch("/api/evaluate_one", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          city,
          date,
          threshold_f: t,
          yes_cents: yesC,
          no_cents: noC
        })
      });
      data = await resp.json();
    }catch(e){
      $("status").textContent = "Network error.";
      setSignal("ERROR");
      return;
    }

    if(!resp.ok || data.error){
      $("status").textContent = `Error: ${data.error || "request_failed"}`;
      setSignal("ERROR");
      return;
    }

    $("cityName").textContent = data.city_name.toUpperCase();

    setSignal(data.signal);

    $("modelLine").textContent = `μ ${fmt4(data.mu)} | σ ${fmt4(data.sigma)}`;
    $("fairLine").textContent = `YES ${fmt4(data.fair_yes)} | NO ${fmt4(data.fair_no)}`;
    $("edgeLine").textContent = `YES ${fmt4(data.edge_yes)} | NO ${fmt4(data.edge_no)}`;

    drawChart(
      data.mu,
      data.sigma,
      data.threshold_f,
      data.fair_yes,
      data.market_yes
    );

    $("status").textContent = `OK — ${data.signal}`;
  }

  $("go").addEventListener("click", (e)=>{ e.preventDefault(); evaluate(); });

  drawChart(50, 6, 50, 0.5, 0.5);
  setSignal("PASS");
</script>
</body>
</html>
