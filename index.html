<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>High Temperature Prediction Market Guidance</title>
  <style>
    :root{
      --bg:#0a0c10;
      --panel:#0f131a;
      --panel2:#0c1016;
      --line:#1b2330;
      --text:#e9eef7;
      --muted:#a0aec2;
      --blue:#7fb4ff;
      --blue2:#a6ccff;
      --good:#2cc38a;
      --warn:#f3c969;
      --bad:#ff6b6b;
      --shadow: 0 16px 55px rgba(0,0,0,.45);
      --radius:10px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;}
    .wrap{max-width:1180px;margin:0 auto;padding:26px 18px 44px}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;padding-bottom:18px;border-bottom:1px solid rgba(255,255,255,.08);}
    .brand{display:flex;flex-direction:column;gap:8px}
    .brand h1{margin:0;font-size:48px;font-weight:900;letter-spacing:.18em;line-height:1;color:var(--text);}
    .sub{color:var(--muted);font-weight:800;letter-spacing:.08em;font-size:13px;}
    .nav{display:flex;gap:10px;justify-content:flex-end; padding-top:6px;}
    .nav a{color:var(--text);text-decoration:none;font-weight:900;padding:10px 12px;border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.03);border-radius: 12px;}
    .nav a:hover{border-color: rgba(127,180,255,.35)}
    .grid{display:grid;grid-template-columns: 1.1fr 1fr;gap:18px;margin-top:22px;}
    .card{background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.10);border-radius: var(--radius);box-shadow: var(--shadow);overflow:hidden;}
    .card-h{padding:16px 16px 12px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;letter-spacing:.14em;font-weight:900;color:#c2cde0;text-transform:uppercase;font-size:12px;}
    .card-b{padding:16px}
    .row{display:grid;grid-template-columns: 1fr 1fr;gap:14px;}
    label{display:block;color:#c2cde0;font-weight:900;letter-spacing:.12em;text-transform:uppercase;font-size:12px;margin-bottom:10px;}
    select, input{width:100%;padding:16px 14px;border-radius: 10px;border:1px solid rgba(255,255,255,.12);background: rgba(10,14,20,.85);color: var(--text);outline:none;font-size:18px;}
    select:focus, input:focus{border-color: rgba(127,180,255,.55)}
    .btn{width:100%;margin-top:14px;padding:16px 16px;border-radius: 10px;border:1px solid rgba(127,180,255,.65);background: rgba(127,180,255,.18);color: var(--text);font-weight:900;font-size:18px;letter-spacing:.04em;cursor:pointer;}
    .btn:hover{filter:brightness(1.05)}
    .status{display:flex;align-items:center;gap:10px;margin-top:14px;color: var(--muted);font-weight:800;}
    .dot{width:10px;height:10px;border-radius:999px;background:#667;box-shadow:0 0 0 3px rgba(255,255,255,.05)}
    .dot.ok{background: var(--good)}
    .dot.err{background: var(--bad)}
    .dot.busy{background: var(--blue)}
    .big{font-size:56px;font-weight:900;letter-spacing:.02em;margin:6px 0 0;}
    .subtitle{color:var(--muted);font-weight:800;letter-spacing:.01em;margin-top:6px;font-size:16px;}
    .miniGrid{display:grid;grid-template-columns: 1fr 1fr;gap:12px;margin-top:14px;}
    .mini{border:1px solid rgba(255,255,255,.10);background: rgba(10,14,20,.55);border-radius: 12px;padding:12px;}
    .mini h4{margin:0 0 8px;letter-spacing:.14em;font-weight:900;text-transform:uppercase;color:#c2cde0;font-size:12px;}
    .mini .val{font-size:14px;font-weight:900;color: var(--text);line-height:1.35;word-break: break-word;}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,14,20,.55);
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size:11px;
      color:#c2cde0;
    }
    .badge .bDot{width:9px;height:9px;border-radius:999px;background:#667;}
    .badge.low .bDot{background: var(--good)}
    .badge.vlow .bDot{background: var(--blue)}
    .badge.med .bDot{background: var(--warn)}
    .badge.high .bDot{background: var(--bad)}

    .chartWrap{margin-top:14px;border:1px solid rgba(255,255,255,.10);background: rgba(10,14,20,.55);border-radius: 12px;padding:12px;position:relative;}
    .legend{position:absolute;top:10px;right:12px;display:flex;gap:12px;align-items:center;font-weight:900;font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#c2cde0;background: rgba(10,14,20,.65);border:1px solid rgba(255,255,255,.10);padding:8px 10px;border-radius: 10px;}
    .sw{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px;}
    .sw.fair{background: var(--blue)}
    .sw.you{background: var(--warn)}
    canvas{width:100%;height:280px;display:block}

    .hrrrList{margin-top:12px;border:1px solid rgba(255,255,255,.10);background: rgba(10,14,20,.55);border-radius: 12px;padding:12px;}
    .hrrrListTop{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;}
    .hrrrList h4{margin:0;letter-spacing:.14em;font-weight:900;text-transform:uppercase;color:#c2cde0;font-size:12px;}
    .hrrrMeta{color:var(--muted);font-weight:900;font-size:12px;letter-spacing:.06em}
    .hrrrRow{display:flex;justify-content:space-between;gap:12px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.07);}
    .hrrrRow:last-child{border-bottom:none;}
    .hrrrT{color:var(--muted);font-weight:900;font-size:12px;letter-spacing:.04em;}
    .hrrrV{font-weight:900;}
    .markHigh{
      padding:2px 8px;
      border-radius: 999px;
      border:1px solid rgba(243,201,105,.35);
      background: rgba(243,201,105,.10);
      color: var(--warn);
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size:10px;
      margin-left:10px;
      white-space:nowrap;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand h1{font-size:36px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>MetApplication</h1>
        <div class="sub">HIGH TEMPERATURE PREDICTION MARKET GUIDANCE</div>
      </div>
      <div class="nav">
        <a href="/drought.html">Drought Odds</a>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="card-h">
          <div>Inputs</div>
          <div id="cityTag" style="font-weight:900;letter-spacing:.14em;color:#c2cde0;text-transform:uppercase;">—</div>
        </div>
        <div class="card-b">
          <div class="row">
            <div>
              <label for="city">City</label>
              <select id="city">
                <option value="den">Denver</option>
                <option value="nyc">New York City</option>
                <option value="dal">Dallas</option>
                <option value="chi">Chicago</option>
              </select>
            </div>
            <div>
              <label for="date">Date</label>
              <select id="date"></select>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div>
              <label for="t">Potential High Temp</label>
              <select id="t"></select>
            </div>
            <div>
              <label for="yes">Yes Cost</label>
              <input id="yes" inputmode="decimal" placeholder="e.g. 32" />
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div>
              <label for="no">No Cost</label>
              <input id="no" inputmode="decimal" placeholder="e.g. 68" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn" id="go">Evaluate Market</button>
            </div>
          </div>

          <div class="miniGrid" style="margin-top:14px;">
            <div class="mini">
              <h4>Local Time</h4>
              <div class="val" id="localTime">—</div>
            </div>
            <div class="mini">
              <h4>Current Temp</h4>
              <div class="val" id="currentTemp">—</div>
            </div>
          </div>

          <div class="hrrrList">
            <div class="hrrrListTop">
              <h4>HRRR 2m temperature — next 12 hours</h4>
              <div class="hrrrMeta" id="hrrrMeta">—</div>
            </div>
            <div id="hrrrBody">
              <div class="hrrrRow"><div class="hrrrT">Status</div><div class="hrrrV">—</div></div>
            </div>
          </div>

          <div class="status" id="status">
            <span class="dot ok" id="dot"></span>
            <span id="statusText">Ready</span>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-h">
          <div>Result</div>
          <div id="cityTop" style="font-weight:900;letter-spacing:.14em;color:#c2cde0;text-transform:uppercase;">—</div>
        </div>
        <div class="card-b">
          <div class="big" id="signal">—</div>
          <div class="subtitle" id="subline">—</div>

          <div class="miniGrid">
            <div class="mini">
              <h4>Fair Yes</h4>
              <div class="val" id="fairYes">—</div>
            </div>
            <div class="mini">
              <h4>Fair No</h4>
              <div class="val" id="fairNo">—</div>
            </div>
            <div class="mini">
              <h4>Your Yes</h4>
              <div class="val" id="yourYes">—</div>
            </div>
            <div class="mini">
              <h4>Your No</h4>
              <div class="val" id="yourNo">—</div>
            </div>
          </div>

          <div class="miniGrid">
            <div class="mini">
              <h4>HRRR High (Selected Date)</h4>
              <div class="val" id="hrrrHigh">—</div>
            </div>
            <div class="mini">
              <h4>Risk (HRRR vs NWS)</h4>
              <div class="val" id="riskBox">—</div>
            </div>
          </div>

          <div class="chartWrap">
            <div class="legend">
              <span><span class="sw fair"></span>Fair Price</span>
              <span><span class="sw you"></span>Your Price</span>
            </div>
            <canvas id="chart" width="900" height="280"></canvas>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  const cityNames = { den:"Denver", nyc:"New York City", dal:"Dallas", chi:"Chicago" };

  let latestHighs = [];
  let latestMu = null;
  let latestSigma = null;

  // For HRRR panel + risk calc
  let latestTz = null;
  let latestHrrrSeries = []; // [{valid_utc, temp_f}]
  let latestHrrrHighForDate = null; // number
  let latestNwsHighForDate = null;  // number (for selected date)

  function setStatus(kind, text){
    const dot = $("dot");
    dot.className = "dot " + (kind || "ok");
    $("statusText").textContent = text;
  }

  function pct(x){
    if (x === null || x === undefined || Number.isNaN(x)) return "—";
    return (x*100).toFixed(1) + "%";
  }
  function money(x){
    if (x === null || x === undefined || Number.isNaN(x)) return "—";
    return (x*100).toFixed(1) + "¢";
  }

  function populateTemps(){
    const sel = $("t");
    sel.innerHTML = "";
    for(let f=40; f<=110; f+=1){
      const o = document.createElement("option");
      o.value = String(f);
      o.textContent = String(f) + "°F";
      sel.appendChild(o);
    }
    sel.value = "73";
  }

  function populateDates(){
    const sel = $("date");
    sel.innerHTML = "";
    for(const h of latestHighs){
      const o = document.createElement("option");
      o.value = h.date;
      o.textContent = h.date;
      sel.appendChild(o);
    }
    // set an initial NWS high for selected date
    refreshNwsHighForSelectedDate();
  }

  function refreshNwsHighForSelectedDate(){
    const d = $("date").value;
    if(!d){ latestNwsHighForDate = null; return; }
    const found = (latestHighs || []).find(x => x.date === d);
    latestNwsHighForDate = found && typeof found.high_f === "number" ? found.high_f : null;
  }

  async function loadHighs(){
    const city = $("city").value;
    $("cityTag").textContent = (cityNames[city] || "—").toUpperCase();
    $("cityTop").textContent = (cityNames[city] || "—").toUpperCase();

    setStatus("busy", "Loading…");
    try{
      const res = await fetch(`/api/highs?city=${encodeURIComponent(city)}`);
      const data = await res.json();
      if(data.error){
        setStatus("err", data.error);
        return;
      }
      latestHighs = data.highs || [];
      populateDates();
      setStatus("ok", "Ready");
    }catch(e){
      setStatus("err", "Network error");
    }
  }

  // ---- Local time + current temp (server gives tz + obs_time) ----
  async function refreshNowPanel(){
    const city = $("city").value;
    try{
      const res = await fetch(`/api/now?city=${encodeURIComponent(city)}`);
      const data = await res.json();
      if(data.error){
        $("localTime").textContent = "—";
        $("currentTemp").textContent = "—";
        latestTz = null;
        return;
      }

      latestTz = data.tz || null;

      if(latestTz){
        const fmt = new Intl.DateTimeFormat(undefined, {
          timeZone: latestTz,
          weekday:"short",
          hour:"numeric",
          minute:"2-digit",
          month:"short",
          day:"numeric"
        });
        $("localTime").textContent = fmt.format(new Date());
      }else{
        // fallback: show obs/server stamp
        const obs = data.obs_time || data.server_utc || "—";
        $("localTime").textContent = obs;
      }

      if(typeof data.temp_f === "number"){
        $("currentTemp").textContent = `${data.temp_f.toFixed(1)}°F`;
      }else{
        $("currentTemp").textContent = "—";
      }
    }catch(e){
      $("localTime").textContent = "—";
      $("currentTemp").textContent = "—";
      latestTz = null;
    }
  }

  function fmtLocalFromUtc(isoUtc){
    try{
      if(!latestTz) return isoUtc.replace("T"," ").replace("Z"," UTC");
      const d = new Date(isoUtc);
      const fmt = new Intl.DateTimeFormat(undefined, {
        timeZone: latestTz,
        weekday:"short",
        hour:"numeric",
        minute:"2-digit",
        month:"short",
        day:"numeric"
      });
      return fmt.format(d);
    }catch(e){
      return String(isoUtc);
    }
  }

  function localDateFromUtc(isoUtc){
    try{
      if(!latestTz) return null;
      const d = new Date(isoUtc);
      // format YYYY-MM-DD in the target tz
      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: latestTz,
        year:"numeric", month:"2-digit", day:"2-digit"
      }).formatToParts(d);
      const y = parts.find(p=>p.type==="year")?.value;
      const m = parts.find(p=>p.type==="month")?.value;
      const da = parts.find(p=>p.type==="day")?.value;
      if(y && m && da) return `${y}-${m}-${da}`;
      return null;
    }catch(e){
      return null;
    }
  }

  // ---- HRRR next 12 hours, plus HRRR high for selected date ----
  async function refreshHrrr(){
    const city = $("city").value;
    const body = $("hrrrBody");
    const meta = $("hrrrMeta");
    body.innerHTML = `<div class="hrrrRow"><div class="hrrrT">Status</div><div class="hrrrV">Loading…</div></div>`;
    meta.textContent = "—";
    latestHrrrSeries = [];
    latestHrrrHighForDate = null;
    $("hrrrHigh").textContent = "—";

    try{
      // Pull 30 hours so we can compute a “selected-date” high reliably
      const res = await fetch(`/api/hrrr_2m?city=${encodeURIComponent(city)}&hours=30`);
      const data = await res.json();
      if(data.error){
        body.innerHTML = `<div class="hrrrRow"><div class="hrrrT">HRRR</div><div class="hrrrV">${data.error}</div></div>`;
        meta.textContent = "hrrr_unavailable";
        return;
      }

      const series = data.series || [];
      latestHrrrSeries = series;

      meta.textContent = `source: HRRR · horizon: 30h`;

      if(!series.length){
        body.innerHTML = `<div class="hrrrRow"><div class="hrrrT">HRRR</div><div class="hrrrV">No data</div></div>`;
        return;
      }

      // Determine selected date (YYYY-MM-DD)
      const selectedDate = $("date").value || null;

      // Compute HRRR high for selected date using local date conversion
      let best = null;
      for(const row of series){
        if(typeof row.temp_f !== "number") continue;
        const ld = localDateFromUtc(row.valid_utc);
        if(selectedDate && ld && ld !== selectedDate) continue;
        best = (best === null) ? row.temp_f : Math.max(best, row.temp_f);
      }
      latestHrrrHighForDate = (typeof best === "number") ? best : null;

      if(latestHrrrHighForDate !== null){
        $("hrrrHigh").textContent = `${latestHrrrHighForDate.toFixed(1)}°F`;
      }else{
        $("hrrrHigh").textContent = "—";
      }

      // Render NEXT 12 HOURS list (always)
      const next12 = series.slice(0, 12);
      // Find the max within those 12 (for label in list)
      let max12 = null;
      for(const row of next12){
        if(typeof row.temp_f !== "number") continue;
        max12 = (max12 === null) ? row.temp_f : Math.max(max12, row.temp_f);
      }

      body.innerHTML = "";
      for(const row of next12){
        const local = fmtLocalFromUtc(row.valid_utc || "—");
        const v = (typeof row.temp_f === "number") ? row.temp_f.toFixed(1)+"°F" : "—";
        const isHigh12 = (max12 !== null && typeof row.temp_f === "number" && Math.abs(row.temp_f - max12) < 0.05);

        const el = document.createElement("div");
        el.className = "hrrrRow";
        el.innerHTML = `
          <div class="hrrrT">${local}${isHigh12 ? `<span class="markHigh">high (next 12h)</span>` : ""}</div>
          <div class="hrrrV">${v}</div>
        `;
        body.appendChild(el);
      }

    }catch(e){
      body.innerHTML = `<div class="hrrrRow"><div class="hrrrT">HRRR</div><div class="hrrrV">Network error</div></div>`;
      meta.textContent = "hrrr_unavailable";
    }
  }

  // ---- Risk (HRRR vs NWS forecast high) ----
  function riskBadgeHtml(level, text){
    const cls = level; // vlow/low/med/high
    return `<span class="badge ${cls}"><span class="bDot"></span>${text}</span>`;
  }

  function computeRisk(signal){
    // Need both highs
    const hrrrHigh = latestHrrrHighForDate;
    const nwsHigh = latestNwsHighForDate;

    if(!(typeof hrrrHigh === "number") || !(typeof nwsHigh === "number")){
      return {html: "—", detail: null};
    }

    const diff = hrrrHigh - nwsHigh; // + means HRRR warmer than NWS

    // Rules you gave:
    // BUY YES: HRRR 2 lower => high risk; 1 lower => medium; same => low; 1 above+ => very low
    // BUY NO: same but opposite direction (HRRR warmer makes NO riskier)
    let level = "low";
    let label = "LOW RISK";

    const isBuyYes = (signal || "").toUpperCase().includes("BUY YES");
    const isBuyNo  = (signal || "").toUpperCase().includes("BUY NO");

    if(isBuyYes){
      if(diff <= -2) { level="high"; label="HIGH RISK"; }
      else if(diff === -1) { level="med"; label="MEDIUM RISK"; }
      else if(diff === 0) { level="low"; label="LOW RISK"; }
      else { level="vlow"; label="VERY LOW RISK"; }
    } else if(isBuyNo){
      // reverse direction
      if(diff >= 2) { level="high"; label="HIGH RISK"; }
      else if(diff === 1) { level="med"; label="MEDIUM RISK"; }
      else if(diff === 0) { level="low"; label="LOW RISK"; }
      else { level="vlow"; label="VERY LOW RISK"; }
    } else {
      return {html: "—", detail: null};
    }

    const detail = `HRRR high ${hrrrHigh.toFixed(1)}°F vs NWS high ${nwsHigh.toFixed(0)}°F (Δ ${diff.toFixed(1)}°F)`;
    return {html: `${riskBadgeHtml(level,label)}<div style="margin-top:8px;color:var(--muted);font-weight:900;font-size:12px;letter-spacing:.04em;">${detail}</div>`, detail};
  }

  // ---- Chart (same prob math as backend) ----
  function erf(x){
    const sign = x >= 0 ? 1 : -1;
    x = Math.abs(x);
    const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;
    const t = 1/(1+p*x);
    const y = 1 - (((((a5*t+a4)*t)+a3)*t+a2)*t+a1)*t*Math.exp(-x*x);
    return sign*y;
  }
  function normCdf(x){ return 0.5*(1+erf(x/Math.sqrt(2))); }
  function probGE(mu,sigma,thr){
    if(!(sigma>0)) return mu>=thr ? 1 : 0;
    const z = (thr - 0.5 - mu)/sigma;
    return Math.max(0, Math.min(1, 1 - normCdf(z)));
  }

  function drawChart(mu, sigma, yourP, tVal){
    const c = $("chart");
    const ctx = c.getContext("2d");
    const w = c.width, h = c.height;

    ctx.clearRect(0,0,w,h);

    const padL = 54, padR = 22, padT = 18, padB = 36;
    const plotW = w - padL - padR;
    const plotH = h - padT - padB;

    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1;

    ctx.fillStyle = "rgba(255,255,255,.35)";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    for(let i=0;i<=4;i++){
      const y = padT + (plotH * (i/4));
      ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL+plotW, y); ctx.stroke();
      const p = (1 - i/4);
      ctx.fillText(Math.round(p*100)+"%", 10, y+4);
    }

    const t0 = Math.max(30, tVal - 10);
    const t1 = Math.min(120, tVal + 10);

    ctx.fillStyle = "rgba(255,255,255,.35)";
    for(let i=0;i<=4;i++){
      const x = padL + (plotW * (i/4));
      const tv = Math.round(t0 + (t1-t0)*(i/4));
      ctx.fillText(tv+"°", x-10, padT+plotH+24);
    }

    ctx.strokeStyle = "rgba(255,255,255,.18)";
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT+plotH);
    ctx.lineTo(padL+plotW, padT+plotH);
    ctx.stroke();

    ctx.lineWidth = 3;
    ctx.strokeStyle = "rgba(127,180,255,.95)";
    ctx.beginPath();
    for(let i=0;i<=160;i++){
      const thr = t0 + (t1-t0)*(i/160);
      const p = probGE(mu, sigma, thr);
      const x = padL + (plotW * ((thr - t0)/(t1-t0)));
      const y = padT + (plotH * (1 - p));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    const fairAtT = probGE(mu, sigma, tVal);

    const xP = padL + (plotW * ((tVal - t0)/(t1-t0)));
    const yF = padT + (plotH * (1 - fairAtT));
    ctx.fillStyle = "rgba(127,180,255,.95)";
    ctx.beginPath(); ctx.arc(xP, yF, 5, 0, Math.PI*2); ctx.fill();

    const yP = padT + (plotH * (1 - Math.max(0, Math.min(1, yourP))));
    ctx.fillStyle = "rgba(243,201,105,.95)";
    ctx.beginPath(); ctx.arc(xP, yP, 6, 0, Math.PI*2); ctx.fill();

    return fairAtT;
  }

  async function evaluate(){
    const city = $("city").value;
    const date = $("date").value;
    const t = parseFloat($("t").value);
    const yes = parseFloat($("yes").value);
    const no = parseFloat($("no").value);

    if(!date || Number.isNaN(t) || Number.isNaN(yes) || Number.isNaN(no)){
      setStatus("err", "Missing inputs");
      return;
    }

    setStatus("busy", "Evaluating…");

    try{
      const res = await fetch("/api/evaluate_one", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ city, date, threshold_f: t, yes_cents: yes, no_cents: no })
      });

      const data = await res.json();
      if(data.error){
        setStatus("err", data.error);
        $("signal").textContent = "—";
        $("subline").textContent = "—";
        $("fairYes").textContent = "—";
        $("fairNo").textContent = "—";
        $("yourYes").textContent = "—";
        $("yourNo").textContent = "—";
        $("riskBox").textContent = "—";
        drawChart(70, 7.5, 0.5, t);
        return;
      }

      const fairYes = data.fair_yes;
      const fairNo = data.fair_no;
      const yourYes = data.market_yes;
      const yourNo = data.market_no;

      latestMu = (typeof data.mu === "number") ? data.mu : null;
      latestSigma = (typeof data.sigma === "number") ? data.sigma : null;

      // Keep NWS forecast high from response (this is the comparison baseline)
      latestNwsHighForDate = (typeof data.mu_forecast_high === "number") ? data.mu_forecast_high : latestNwsHighForDate;

      $("signal").textContent = data.signal;
      const muTxt = (typeof data.mu === "number") ? `${data.mu.toFixed(1)}°F` : "—";
      const muF = (typeof data.mu_forecast_high === "number") ? `${data.mu_forecast_high.toFixed(1)}°F` : "—";
      $("subline").textContent = `Fair YES ${pct(fairYes)} · μ(nowcast) ${muTxt} · μ(forecast) ${muF}`;

      $("fairYes").textContent = pct(fairYes);
      $("fairNo").textContent = pct(fairNo);
      $("yourYes").textContent = money(yourYes);
      $("yourNo").textContent = money(yourNo);

      const muForChart = (latestMu ?? 70);
      const sgForChart = (latestSigma ?? 7.5);
      drawChart(muForChart, sgForChart, yourYes, t);

      // Risk box (needs HRRR high too)
      const r = computeRisk(data.signal);
      $("riskBox").innerHTML = r.html;

      setStatus("ok", "OK");
    }catch(e){
      setStatus("err", "Network error");
    }
  }

  $("city").addEventListener("change", async ()=>{
    await loadHighs();
    refreshNwsHighForSelectedDate();
    await refreshNowPanel();
    await refreshHrrr();
    // Update risk in case last eval exists
    const r = computeRisk($("signal").textContent || "");
    $("riskBox").innerHTML = r.html || "—";
  });

  $("date").addEventListener("change", async ()=>{
    refreshNwsHighForSelectedDate();
    await refreshHrrr(); // recompute HRRR high for selected date
    const r = computeRisk($("signal").textContent || "");
    $("riskBox").innerHTML = r.html || "—";
  });

  $("go").addEventListener("click", evaluate);

  (function init(){
    populateTemps();
    loadHighs().then(async ()=>{
      $("cityTag").textContent = (cityNames[$("city").value] || "—").toUpperCase();
      $("cityTop").textContent = (cityNames[$("city").value] || "—").toUpperCase();
      refreshNwsHighForSelectedDate();
      await refreshNowPanel();
      await refreshHrrr();
      $("riskBox").textContent = "—";
      $("hrrrHigh").textContent = "—";
      drawChart(70, 7.5, 0.5, 73);
    });
  })();
</script>
</body>
</html>
