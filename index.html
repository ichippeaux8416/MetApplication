<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>High Temperature Prediction Market Guidance</title>
  <style>
    :root{
      --bg:#0a0c10;
      --panel:#0f131a;
      --panel2:#0c1016;
      --line:#1b2330;
      --text:#e9eef7;
      --muted:#a0aec2;
      --blue:#7fb4ff;
      --blue2:#a6ccff;
      --good:#2cc38a;
      --warn:#f3c969;
      --bad:#ff6b6b;
      --shadow: 0 16px 55px rgba(0,0,0,.45);
      --radius:10px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;}
    .wrap{max-width:1180px;margin:0 auto;padding:26px 18px 44px}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;padding-bottom:18px;border-bottom:1px solid rgba(255,255,255,.08);}
    .brand{display:flex;flex-direction:column;gap:8px}
    .brand h1{margin:0;font-size:48px;font-weight:900;letter-spacing:.18em;line-height:1;color:var(--text);}
    .sub{color:var(--muted);font-weight:800;letter-spacing:.08em;font-size:13px;}
    .nav{display:flex;gap:10px;justify-content:flex-end; padding-top:6px;}
    .nav a{color:var(--text);text-decoration:none;font-weight:900;padding:10px 12px;border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.03);border-radius: 12px;}
    .nav a:hover{border-color: rgba(127,180,255,.35)}
    .grid{display:grid;grid-template-columns: 1.1fr 1fr;gap:18px;margin-top:22px;}
    .card{background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.10);border-radius: var(--radius);box-shadow: var(--shadow);overflow:hidden;}
    .card-h{padding:16px 16px 12px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;letter-spacing:.14em;font-weight:900;color:#c2cde0;text-transform:uppercase;font-size:12px;}
    .card-b{padding:16px}
    .row{display:grid;grid-template-columns: 1fr 1fr;gap:14px;}
    label{display:block;color:#c2cde0;font-weight:900;letter-spacing:.12em;text-transform:uppercase;font-size:12px;margin-bottom:10px;}
    select, input{width:100%;padding:16px 14px;border-radius: 10px;border:1px solid rgba(255,255,255,.12);background: rgba(10,14,20,.85);color: var(--text);outline:none;font-size:18px;}
    select:focus, input:focus{border-color: rgba(127,180,255,.55)}
    .btn{width:100%;margin-top:14px;padding:16px 16px;border-radius: 10px;border:1px solid rgba(127,180,255,.65);background: rgba(127,180,255,.18);color: var(--text);font-weight:900;font-size:18px;letter-spacing:.04em;cursor:pointer;}
    .btn:hover{filter:brightness(1.05)}
    .status{display:flex;align-items:center;gap:10px;margin-top:14px;color: var(--muted);font-weight:800;}
    .dot{width:10px;height:10px;border-radius:999px;background:#667;box-shadow:0 0 0 3px rgba(255,255,255,.05)}
    .dot.ok{background: var(--good)}
    .dot.err{background: var(--bad)}
    .dot.busy{background: var(--blue)}
    .big{font-size:56px;font-weight:900;letter-spacing:.02em;margin:6px 0 0;}
    .subtitle{color:var(--muted);font-weight:800;letter-spacing:.01em;margin-top:6px;font-size:16px;}
    .miniGrid{display:grid;grid-template-columns: 1fr 1fr;gap:12px;margin-top:14px;}
    .mini{border:1px solid rgba(255,255,255,.10);background: rgba(10,14,20,.55);border-radius: 12px;padding:12px;}
    .mini h4{margin:0 0 8px;letter-spacing:.14em;font-weight:900;text-transform:uppercase;color:#c2cde0;font-size:12px;}
    .mini .val{font-size:14px;font-weight:900;color: var(--text);line-height:1.35;word-break: break-word;}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(10,14,20,.65);font-weight:900;letter-spacing:.08em;text-transform:uppercase;font-size:12px;}
    .pill .pDot{width:10px;height:10px;border-radius:999px;background:#666;}
    .pill.low .pDot{background: var(--good)}
    .pill.med .pDot{background: var(--warn)}
    .pill.high .pDot{background: var(--bad)}
    .pill.vlow .pDot{background: var(--blue)}
    .chartWrap{margin-top:14px;border:1px solid rgba(255,255,255,.10);background: rgba(10,14,20,.55);border-radius: 12px;padding:12px;position:relative;}
    .legend{position:absolute;top:10px;right:12px;display:flex;gap:12px;align-items:center;font-weight:900;font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#c2cde0;background: rgba(10,14,20,.65);border:1px solid rgba(255,255,255,.10);padding:8px 10px;border-radius: 10px;}
    .sw{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px;}
    .sw.fair{background: var(--blue)}
    .sw.you{background: var(--warn)}
    canvas{width:100%;height:280px;display:block}
    .modelList{margin-top:12px;border:1px solid rgba(255,255,255,.10);background: rgba(10,14,20,.55);border-radius: 12px;padding:12px;}
    .modelList h4{margin:0 0 10px;letter-spacing:.14em;font-weight:900;text-transform:uppercase;color:#c2cde0;font-size:12px;}
    .mRow{display:flex;justify-content:space-between;gap:12px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.07);}
    .mRow:last-child{border-bottom:none;}
    .mT{color:var(--muted);font-weight:900;font-size:12px;letter-spacing:.08em;text-transform:uppercase;}
    .mV{font-weight:900;}
    .tag{display:inline-block;margin-left:10px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(10,14,20,.65);font-weight:900;font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#c2cde0;}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand h1{font-size:36px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>MetApplication</h1>
        <div class="sub">HIGH TEMPERATURE PREDICTION MARKET GUIDANCE</div>
      </div>
      <div class="nav">
        <a href="/drought.html">Drought Odds</a>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="card-h">
          <div>Inputs</div>
          <div id="cityTag" style="font-weight:900;letter-spacing:.14em;color:#c2cde0;text-transform:uppercase;">—</div>
        </div>
        <div class="card-b">
          <div class="row">
            <div>
              <label for="city">City</label>
              <select id="city">
                <option value="den">Denver</option>
                <option value="nyc">New York City</option>
                <option value="dal">Dallas</option>
                <option value="chi">Chicago</option>
                <option value="lax">Los Angeles</option>
                <option value="sea">Seattle</option>
                <option value="sfo">San Francisco</option>
                <option value="hou">Houston</option>
                <option value="aus">Austin</option>
                <option value="sat">San Antonio</option>
                <option value="okc">Oklahoma City</option>
                <option value="phx">Phoenix</option>
                <option value="las">Las Vegas</option>
                <option value="msp">Minneapolis–Saint Paul</option>
                <option value="bna">Nashville</option>
              </select>
            </div>
            <div>
              <label for="date">Date</label>
              <select id="date"></select>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div>
              <label for="t">Potential High Temp</label>
              <select id="t"></select>
            </div>
            <div>
              <label for="yes">Yes Cost</label>
              <input id="yes" inputmode="decimal" placeholder="e.g. 32" />
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div>
              <label for="no">No Cost</label>
              <input id="no" inputmode="decimal" placeholder="e.g. 68" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn" id="go">Evaluate Market</button>
            </div>
          </div>

          <div class="miniGrid" style="margin-top:14px;">
            <div class="mini">
              <h4>Local Time</h4>
              <div class="val" id="localTime">—</div>
            </div>
            <div class="mini">
              <h4>Current Temp</h4>
              <div class="val" id="currentTemp">—</div>
            </div>
          </div>

          <div class="modelList">
            <h4>HRRR 2m temperature — next 12 hours</h4>
            <div id="hrrrBody">
              <div class="mRow"><div class="mT">Status</div><div class="mV">—</div></div>
            </div>
          </div>

          <div class="modelList">
            <h4>RAP 2m temperature — next 12 hours</h4>
            <div id="rapBody">
              <div class="mRow"><div class="mT">Status</div><div class="mV">—</div></div>
            </div>
          </div>

          <div class="status" id="status">
            <span class="dot ok" id="dot"></span>
            <span id="statusText">Ready</span>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-h">
          <div>Result</div>
          <div id="cityTop" style="font-weight:900;letter-spacing:.14em;color:#c2cde0;text-transform:uppercase;">—</div>
        </div>
        <div class="card-b">
          <div class="big" id="signal">—</div>
          <div class="subtitle" id="subline">—</div>

          <div class="miniGrid">
            <div class="mini">
              <h4>Fair Yes</h4>
              <div class="val" id="fairYes">—</div>
            </div>
            <div class="mini">
              <h4>Fair No</h4>
              <div class="val" id="fairNo">—</div>
            </div>
            <div class="mini">
              <h4>Your Yes</h4>
              <div class="val" id="yourYes">—</div>
            </div>
            <div class="mini">
              <h4>Your No</h4>
              <div class="val" id="yourNo">—</div>
            </div>

            <div class="mini">
              <h4>HRRR vs NWS Risk</h4>
              <div class="val">
                <span id="riskPillHrrr" class="pill low"><span class="pDot"></span><span id="riskLabelHrrr">—</span></span>
                <div style="margin-top:8px;color:var(--muted);font-weight:900;">Δ(HRRR−NWS) <span id="deltaHrrr">—</span></div>
              </div>
            </div>

            <div class="mini">
              <h4>RAP vs NWS Risk</h4>
              <div class="val">
                <span id="riskPillRap" class="pill low"><span class="pDot"></span><span id="riskLabelRap">—</span></span>
                <div style="margin-top:8px;color:var(--muted);font-weight:900;">Δ(RAP−NWS) <span id="deltaRap">—</span></div>
              </div>
            </div>
          </div>

          <div class="chartWrap">
            <div class="legend">
              <span><span class="sw fair"></span>Fair Price</span>
              <span><span class="sw you"></span>Your Price</span>
            </div>
            <canvas id="chart"></canvas>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  const cityNames = { den:"Denver", nyc:"New York City", dal:"Dallas", chi:"Chicago", lax:"Los Angeles", sea:"Seattle", sfo:"San Francisco", hou:"Houston", aus:"Austin", sat:"San Antonio", okc:"Oklahoma City", phx:"Phoenix", las:"Las Vegas", msp:"Minneapolis–Saint Paul", bna:"Nashville" };

  let latestHighs = [];
  let latestMu = null;
  let latestSigma = null;

  // caches from /api/hrrr_four and /api/rap_four
  let modelCache = { hrrr: null, rap: null };

  function setStatus(kind, text){
    const dot = $("dot");
    dot.className = "dot " + (kind || "ok");
    $("statusText").textContent = text;
  }

  function pct(x){
    if (x === null || x === undefined || Number.isNaN(x)) return "—";
    return (x*100).toFixed(1) + "%";
  }
  function money(x){
    if (x === null || x === undefined || Number.isNaN(x)) return "—";
    return (x*100).toFixed(1) + "¢";
  }

  function populateTemps(){
    const sel = $("t");
    sel.innerHTML = "";
    for(let f=0; f<=120; f+=1){
      const o = document.createElement("option");
      o.value = String(f);
      o.textContent = String(f) + "°F";
      sel.appendChild(o);
    }
    sel.value = "73";
  }

  function populateDates(){
    const sel = $("date");
    sel.innerHTML = "";
    for(const h of latestHighs){
      const o = document.createElement("option");
      o.value = h.date;
      o.textContent = h.date;
      sel.appendChild(o);
    }
  }

  async function loadHighs(){
    const city = $("city").value;
    $("cityTag").textContent = (cityNames[city] || "—").toUpperCase();
    $("cityTop").textContent = (cityNames[city] || "—").toUpperCase();

    setStatus("busy", "Loading…");
    try{
      const res = await fetch(`/api/highs?city=${encodeURIComponent(city)}`);
      const data = await res.json();
      if(data.error){
        setStatus("err", data.error);
        return;
      }
      latestHighs = data.highs || [];
      populateDates();
      setStatus("ok", "Ready");
    }catch(e){
      setStatus("err", "Network error");
    }
  }

  async function refreshNowPanel(){
    const city = $("city").value;
    try{
      const res = await fetch(`/api/now?city=${encodeURIComponent(city)}`);
      const data = await res.json();
      if(data.error){
        $("localTime").textContent = "—";
        $("currentTemp").textContent = "—";
        return;
      }
      const tz = data.tz || "—";
      const obs = data.obs_time || data.server_utc || "—";
      $("localTime").textContent = `${obs} (${tz})`;
      if(typeof data.temp_f === "number"){
        $("currentTemp").textContent = `${data.temp_f.toFixed(1)}°F`;
      }else{
        $("currentTemp").textContent = "—";
      }
    }catch(e){
      $("localTime").textContent = "—";
      $("currentTemp").textContent = "—";
    }
  }

  function fmtLocalFromISO(isoZ, tz){
    try{
      // If browser supports timeZone, use it. If not, fall back to UTC label.
      const d = new Date(isoZ);
      if(!tz) return d.toUTCString().replace("GMT","UTC");
      return new Intl.DateTimeFormat(undefined, {
        weekday:"short", month:"short", day:"numeric",
        hour:"numeric", minute:"2-digit",
        timeZone: tz
      }).format(d);
    }catch(e){
      return String(isoZ || "—");
    }
  }

  function computeForecastHighForDate(series, dateISO, tz){
    // Use local date match when possible; if Intl fails, fall back to UTC date prefix.
    let best = null;
    for(const p of (series||[])){
      if(!p.valid_utc) continue;
      const d = new Date(p.valid_utc);
      let localDate = null;
      try{
        if(tz){
          const parts = new Intl.DateTimeFormat("en-CA",{timeZone:tz, year:"numeric", month:"2-digit", day:"2-digit"}).formatToParts(d);
          const y = parts.find(x=>x.type==="year")?.value;
          const m = parts.find(x=>x.type==="month")?.value;
          const da = parts.find(x=>x.type==="day")?.value;
          if(y && m && da) localDate = `${y}-${m}-${da}`;
        }
      }catch(e){}
      const compareDate = localDate || d.toISOString().slice(0,10);
      if(compareDate !== dateISO) continue;
      if(typeof p.temp_f !== "number") continue;
      if(best === null || p.temp_f > best) best = p.temp_f;
    }
    return best;
  }

  function renderModelList(bodyEl, modelName, payload, cityCode, tz){
    const body = bodyEl;
    const cityObj = payload?.cities?.[cityCode];
    const series = cityObj?.series || [];
    if(!series.length){
      body.innerHTML = `<div class="mRow"><div class="mT">${modelName}</div><div class="mV">No data</div></div>`;
      return {series:[], high:null, asof: payload?.asof_utc || null};
    }
    body.innerHTML = "";
    const dateISO = $("date").value;
    const hi = computeForecastHighForDate(series, dateISO, tz);
    for(const row of series){
      const t = fmtLocalFromISO(row.valid_utc, tz);
      const v = (typeof row.temp_f === "number") ? row.temp_f.toFixed(1)+"°F" : "—";
      const isHigh = (hi !== null && typeof row.temp_f === "number" && Math.abs(row.temp_f - hi) < 0.05);
      const el = document.createElement("div");
      el.className = "mRow";
      el.innerHTML = `<div class="mT">${t}</div><div class="mV">${v}${isHigh ? `<span class="tag">FORECAST HIGH</span>` : ""}</div>`;
      body.appendChild(el);
    }
    return {series, high:hi, asof: payload?.asof_utc || null};
  }

  function riskClass(label){
    const s = String(label||"").toLowerCase();
    if(s.includes("very low")) return "vlow";
    if(s.includes("low")) return "low";
    if(s.includes("medium")) return "med";
    if(s.includes("high")) return "high";
    return "low";
  }

  function riskFromDelta(signal, delta){
    // signal is BUY YES / BUY NO / PASS
    if(!isFinite(delta)) return {label:"—", cls:"low"};
    const d = Math.round(delta); // treat 0.4 as 0, 1.2 as 1 etc.
    if(signal === "BUY YES"){
      if(d <= -2) return {label:"HIGH RISK", cls:"high"};
      if(d === -1) return {label:"MEDIUM RISK", cls:"med"};
      if(d === 0) return {label:"LOW RISK", cls:"low"};
      if(d >= 1) return {label:"VERY LOW RISK", cls:"vlow"};
    }
    if(signal === "BUY NO"){
      if(d >= 2) return {label:"HIGH RISK", cls:"high"};
      if(d === 1) return {label:"MEDIUM RISK", cls:"med"};
      if(d === 0) return {label:"LOW RISK", cls:"low"};
      if(d <= -1) return {label:"VERY LOW RISK", cls:"vlow"};
    }
    return {label:"—", cls:"low"};
  }

  async function refreshModels12(){
    const city = $("city").value;
    const dateISO = $("date").value;

    // get tz from /api/now (already fetched in UI); reuse by parsing localTime label if needed
    let tz = null;
    try{
      const res = await fetch(`/api/now?city=${encodeURIComponent(city)}`);
      const data = await res.json();
      tz = data.tz || null;
    }catch(e){}

    // HRRR
    const hrrrBody = $("hrrrBody");
    hrrrBody.innerHTML = `<div class="mRow"><div class="mT">Status</div><div class="mV">Loading…</div></div>`;
    try{
      const res = await fetch(`/api/hrrr_four?hours=12`);
      const data = await res.json();
      modelCache.hrrr = data;
      if(data.error){
        hrrrBody.innerHTML = `<div class="mRow"><div class="mT">HRRR</div><div class="mV">${data.error}</div></div>`;
      }else{
        const meta = renderModelList(hrrrBody, "HRRR", data, city, tz);
        // stash computed high for later risk calc
        modelCache.hrrr_high = meta.high;
      }
    }catch(e){
      hrrrBody.innerHTML = `<div class="mRow"><div class="mT">HRRR</div><div class="mV">Network error</div></div>`;
    }

    // RAP
    const rapBody = $("rapBody");
    rapBody.innerHTML = `<div class="mRow"><div class="mT">Status</div><div class="mV">Loading…</div></div>`;
    try{
      const res = await fetch(`/api/rap_four?hours=12`);
      const data = await res.json();
      modelCache.rap = data;
      if(data.error){
        rapBody.innerHTML = `<div class="mRow"><div class="mT">RAP</div><div class="mV">${data.error}</div></div>`;
      }else{
        const meta = renderModelList(rapBody, "RAP", data, city, tz);
        modelCache.rap_high = meta.high;
      }
    }catch(e){
      rapBody.innerHTML = `<div class="mRow"><div class="mT">RAP</div><div class="mV">Network error</div></div>`;
    }
  }

  // ---- Chart math (must match backend) ----
  function erf(x){
    const sign = x >= 0 ? 1 : -1;
    x = Math.abs(x);
    const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;
    const t = 1/(1+p*x);
    const y = 1 - (((((a5*t+a4)*t)+a3)*t+a2)*t+a1)*t*Math.exp(-x*x);
    return sign*y;
  }
  function normCdf(x){ return 0.5*(1+erf(x/Math.sqrt(2))); }
  function probGE(mu,sigma,thr){
    if(!(sigma>0)) return mu>=thr ? 1 : 0;
    const z = (thr - 0.5 - mu)/sigma;
    return Math.max(0, Math.min(1, 1 - normCdf(z)));
  }

  function drawChart(mu, sigma, yourP, tVal){
    const c = $("chart");
    const rect = c.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;

    // Fix "not to scale" rendering by drawing at device pixel density.
    const targetW = Math.max(300, Math.round(rect.width * dpr));
    const targetH = Math.max(200, Math.round(rect.height * dpr));
    if (c.width !== targetW || c.height !== targetH){
      c.width = targetW;
      c.height = targetH;
    }

    const ctx = c.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
    const w = rect.width;
    const h = rect.height;

    ctx.clearRect(0,0,w,h);

    const padL = 54, padR = 22, padT = 18, padB = 36;
    const plotW = w - padL - padR;
    const plotH = h - padT - padB;

    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1;

    ctx.fillStyle = "rgba(255,255,255,.35)";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    for(let i=0;i<=4;i++){
      const y = padT + (plotH * (i/4));
      ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL+plotW, y); ctx.stroke();
      const p = (1 - i/4);
      ctx.fillText(Math.round(p*100)+"%", 10, y+4);
    }

    const t0 = Math.max(0, tVal - 10);
    const t1 = Math.min(120, tVal + 10);

    ctx.fillStyle = "rgba(255,255,255,.35)";
    for(let i=0;i<=4;i++){
      const x = padL + (plotW * (i/4));
      const tv = Math.round(t0 + (t1-t0)*(i/4));
      ctx.fillText(tv+"°", x-10, padT+plotH+24);
    }

    ctx.strokeStyle = "rgba(255,255,255,.18)";
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT+plotH);
    ctx.lineTo(padL+plotW, padT+plotH);
    ctx.stroke();

    ctx.lineWidth = 3;
    ctx.strokeStyle = "rgba(127,180,255,.95)";
    ctx.beginPath();
    for(let i=0;i<=160;i++){
      const thr = t0 + (t1-t0)*(i/160);
      const p = probGE(mu, sigma, thr);
      const x = padL + (plotW * ((thr - t0)/(t1-t0)));
      const y = padT + (plotH * (1 - p));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    const fairAtT = probGE(mu, sigma, tVal);

    const xP = padL + (plotW * ((tVal - t0)/(t1-t0)));
    const yF = padT + (plotH * (1 - fairAtT));
    ctx.fillStyle = "rgba(127,180,255,.95)";
    ctx.beginPath(); ctx.arc(xP, yF, 5, 0, Math.PI*2); ctx.fill();

    const yP = padT + (plotH * (1 - Math.max(0, Math.min(1, yourP))));
    ctx.fillStyle = "rgba(243,201,105,.95)";
    ctx.beginPath(); ctx.arc(xP, yP, 6, 0, Math.PI*2); ctx.fill();

    return fairAtT;
  }

  function setRiskUI(prefix, risk){
    const pill = $(prefix==="hrrr" ? "riskPillHrrr" : "riskPillRap");
    const lab = $(prefix==="hrrr" ? "riskLabelHrrr" : "riskLabelRap");
    pill.className = "pill " + risk.cls;
    lab.textContent = risk.label;
  }

  async function evaluate(){
    const city = $("city").value;
    const date = $("date").value;
    const t = parseFloat($("t").value);
    const yes = parseFloat($("yes").value);
    const no = parseFloat($("no").value);

    if(!date || Number.isNaN(t) || Number.isNaN(yes) || Number.isNaN(no)){
      setStatus("err", "Missing inputs");
      return;
    }

    setStatus("busy", "Evaluating…");

    try{
      const res = await fetch("/api/evaluate_one", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ city, date, threshold_f: t, yes_cents: yes, no_cents: no })
      });

      const data = await res.json();
      if(data.error){
        setStatus("err", data.error);
        $("signal").textContent = "—";
        $("subline").textContent = "—";
        $("fairYes").textContent = "—";
        $("fairNo").textContent = "—";
        $("yourYes").textContent = "—";
        $("yourNo").textContent = "—";
        $("deltaHrrr").textContent = "—";
        $("deltaRap").textContent = "—";
        setRiskUI("hrrr",{label:"—",cls:"low"});
        setRiskUI("rap",{label:"—",cls:"low"});
        drawChart(70, 7.5, 0.5, t);
        return;
      }

      const fairYes = data.fair_yes;
      const fairNo = data.fair_no;
      const yourYes = data.market_yes;
      const yourNo = data.market_no;

      latestMu = (typeof data.mu === "number") ? data.mu : null;
      latestSigma = (typeof data.sigma === "number") ? data.sigma : null;

      $("signal").textContent = data.signal;

      const muTxt = (typeof data.mu === "number") ? `${data.mu.toFixed(1)}°F` : "—";
      const muF = (typeof data.mu_forecast_high === "number") ? `${data.mu_forecast_high.toFixed(1)}°F` : "—";
      $("subline").textContent = `Fair YES ${pct(fairYes)} · μ(nowcast) ${muTxt} · μ(NWS high) ${muF}`;

      $("fairYes").textContent = pct(fairYes);
      $("fairNo").textContent = pct(fairNo);
      $("yourYes").textContent = money(yourYes);
      $("yourNo").textContent = money(yourNo);

      // Draw chart using SAME mu/sigma used to compute fairYes
      const muForChart = (latestMu ?? 70);
      const sgForChart = (latestSigma ?? 7.5);
      drawChart(muForChart, sgForChart, yourYes, t);

      // Model risk: compare each model's (12h) forecast high for selected date vs NWS high
      const nwsHigh = (typeof data.mu_forecast_high === "number") ? data.mu_forecast_high : null;

      const hHigh = (typeof modelCache.hrrr_high === "number") ? modelCache.hrrr_high : null;
      const rHigh = (typeof modelCache.rap_high === "number") ? modelCache.rap_high : null;

      const dH = (nwsHigh !== null && hHigh !== null) ? (hHigh - nwsHigh) : NaN;
      const dR = (nwsHigh !== null && rHigh !== null) ? (rHigh - nwsHigh) : NaN;

      $("deltaHrrr").textContent = isFinite(dH) ? `${dH.toFixed(1)}°F` : "—";
      $("deltaRap").textContent = isFinite(dR) ? `${dR.toFixed(1)}°F` : "—";

      const riskH = riskFromDelta(data.signal, dH);
      const riskR = riskFromDelta(data.signal, dR);

      setRiskUI("hrrr", riskH);
      setRiskUI("rap", riskR);

      setStatus("ok", "OK");
    }catch(e){
      setStatus("err", "Network error");
    }
  }

  $("city").addEventListener("change", async ()=>{
    await loadHighs();
    await refreshNowPanel();
    await refreshModels12();
  });

  $("date").addEventListener("change", async ()=>{
    await refreshModels12(); // re-tag forecast-high for selected date
  });

  $("go").addEventListener("click", evaluate);

  window.addEventListener("resize", ()=>{
    const t = parseFloat($("t").value || "73");
    const muForChart = (latestMu ?? 70);
    const sgForChart = (latestSigma ?? 7.5);
    drawChart(muForChart, sgForChart, 0.5, t);
  });

  (function init(){
    populateTemps();
    loadHighs().then(async ()=>{
      $("cityTag").textContent = (cityNames[$("city").value] || "—").toUpperCase();
      $("cityTop").textContent = (cityNames[$("city").value] || "—").toUpperCase();
      await refreshNowPanel();
      await refreshModels12();
      drawChart(70, 7.5, 0.5, 73);
    });
  })();
</script>
</body>
</html>
